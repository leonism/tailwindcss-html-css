'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[15],{1212:function(t,D,a){var c=a(10);t=a(0);var b=a(15),d=a(690),f=a(50),e=a(37),k=a(1272),l=a(234),m=a(21),v=a(245),n=a(258),w=a(12),r=a(90),u=a(1);class x extends l.a{constructor(G){super(document.createElement("div"));this.Qrj=T=>{this.fk=T};this.$=G;this.grid=m.g(G)}static init(G){x.Ma?b.ULS.sendTraceTag(522782307,1,15,"FormulaSuggestionUIControl.init: unexpected call after already being inited."):x.Ma=new x(G)}static instance(){return x.Ma}get jf(){return null!=
this.fk}get Zd(){return v.a.yTe}get lc(){return this.fk}gg(G,T){T||w.DOMElementExtensions.setFocus(this.lc);return!T}hh(G){if(null!=this.lc)return w.DOMElementExtensions.uf(this.lc,G);b.ULS.sendTraceTag(526197124,1,50,"FormulaSuggestionUIControl.belongsToSection: card rootElement should not be null.");return!1}kj(){}Mj(){}show(G,T,W,P,E,H=null,F=null,N=null){if(!F&&this.$){F=this.grid.Xb(N);if(!F){b.ULS.sendTraceTag(537161875,1,50,"FormulaSuggestionUIControl.Show: failed to show UI, formattedActiveCell is null.");
return}if(!F.cell.Ck){b.ULS.sendTraceTag(537161874,1,50,"FormulaSuggestionUIControl.Show: failed to show UI, formattedActiveCell is not in view.");return}F=this.grid.getCellBounds(F.cell,!0);b.ULS.shipAssertTag(537161873,1,!!F,"FormulaSuggestionUIControl.Show: target cell bounds should not be null.")}b.ULS.sendTraceTag(537161872,1,50,"FormulaSuggestionUIControl.Show: calling AppChrome API to render card UI.");n.a(this.$).Xh(this);appChrome.renderFormulaSuggestionCard(G,T,this.domElement,F.y,F.x,F.y+
F.height,F.x+F.width,W,P,E,H,this.Qrj)}hide(){b.ULS.sendTraceTag(537161871,1,50,"FormulaSuggestionUIControl.Hide: calling AppChrome API to unmount card UI.");n.a(this.$).Nz(this);appChrome.unmountReactComponent(this.domElement)}lda(G,T,W){u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FBECurtainLifterCalloutForTestingOnlyEnabled",!1)&&(this.o0a&&G.equals(this.Epi)||(this.o0a&&document.body.removeChild(this.o0a),this.Epi=G,G=this.grid.Xb(G),G=this.grid.getCellBounds(G.cell,!0),this.o0a=
document.createElement("div"),this.o0a.setAttribute("style",`position:fixed;
        left: ${G.x+G.width}px;
        top: ${G.y+G.height/2}px`),document.body.appendChild(this.o0a)),G=new r.a(-847286761,0,this.$.Mc,0,null),this.$.Ka.Lb(G,{["CalloutName"]:15,["Target"]:this.o0a,["NewState"]:T,["Reason"]:W}))}}Object(t.a)(x,"FormulaSuggestionUIControl",l.a,[692,110]);class z extends d.a{constructor(G){super(G)}Dd(){b.ULS.sendTraceTag(528758224,0,50,"FormulaByExampleCommandHandlerFactory.CreateCommandHandlersAsync: FormulaByExampleCommandHandler init flow started.");const G=f.GetServiceTaskFactory.Ta(this.$.da,
453,454,1),T=f.GetServiceTaskFactory.Ta(this.$.da,266,265,1);e.TaskExtensions.Aa(e.TaskExtensions.Xd([G,T],this.la),()=>{const W=this.$.da.za(328);this.ld([new k.a(this.$,W,T.result,G.result,x.instance())]);b.ULS.sendTraceTag(537161924,0,50,"FormulaByExampleCommandHandlerFactory.CreateCommandHandlersAsync: FormulaByExampleCommandHandler initialized successfully")},this.la)}static ka(G){d.a.Rd(455,new z(G))}}Object(t.a)(z,"FormulaByExampleCommandHandlerFactory",d.a,[]);var B=a(55);l=a(220);var y=a(929);
class A extends l.a{constructor(G){super();this.$=G;this.Fb()}create(){b.ULS.sendTraceTag(528758214,0,50,"FormulaByExampleManagerFactory.Create: starting service creation flow.");const G=f.GetServiceTaskFactory.Ta(this.$.da,328,327,1),T=f.GetServiceTaskFactory.Ta(this.$.da,266,265,1),W=u.EwaSettings.isChangeGateEnabled("OfficeVSO:6327953_FormatOutputResultsOfFBEDeprecated")?B.Task.Ua(null):f.GetServiceTaskFactory.create(this.$.da,18,this.$.la,1),P=[G,T,W];x.init(this.$);e.TaskExtensions.Aa(e.TaskExtensions.Xd(P,
this.la),()=>{b.ULS.sendTraceTag(528758213,0,50,"FormulaByExampleManagerFactory.Create: augmentationLoopManager and calcManager creation tasks resolved.");const E=new y.a(this.$,G.result,T.result,W.result,x.instance());this.qb(this.$.da.za(453)||this.$.da.Ga(453,E));b.ULS.sendTraceTag(537161882,0,50,"FormulaByExampleManagerFactory.Create: FormulaByExampleManager initialized successfully")},this.la)}static ka(G){G.da.Ga(454,new A(G))}}Object(t.a)(A,"FormulaByExampleManagerFactory",l.a,[]);a.d(D,"a",
function(){return K});const K=()=>{c.a.Fa(G=>{A.ka(G);z.ka(G)})}},1272:function(t,D,a){t=a(0);var c=a(7),b=a(15),d=a(24),f=a(36),e=a(162),k=a(181),l=a(21),m=a(864),v=a(694);class n extends m.a{constructor(){super();this.formulasCount=this.columnNames=this.additionalInputs=this.examples=null;this.invocationMethod=this.stateID=0;this.guid=this.supportedFunctions=null;this.H_=Object.assign(new v.a,{T_:n.getTypeName(),B_:n.Od()})}static getTypeName(){return"AugLoop_FormulaByExample_FormulaByExampleSignal"}static Od(){return["AugLoop_Signals_Signal"]}}
Object(t.a)(n,"FormulaByExampleSignal",m.a,[]);var w=a(1280),r=a(55),u=a(813),x=a(929),z=a(1),B=a(454),y=a(848);a.d(D,"b",function(){return A});a.d(D,"a",function(){return K});const A={b6c:"editRange",HVd:"triggerKind",BSe:"flowId",Xcf:"isInTable"};class K{constructor(G,T,W,P,E){this.IB=!1;this.$=G;this.gridView=l.g(G);this.augmentationLoopManager=T;this.calcManager=W;this.formulaByExampleManager=P;this.QJ=E;this.Mp=y.a.getInstance(this.$);this.IB=Object(u.a)(this.$);this.Tyi=z.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FormulaByExampleMaximalNumberOfAdditionalInputRows",
30);b.ULS.sendTraceTag(528758226,306,50,"FormulaByExampleCommandHandler.ctor: FBE command handler created")}Qc(){return!1}executeCommand(G,T,W){G=!1;T=T.command;switch(T){case 1928326585:G=W&&W[A.HVd]?W[A.HVd]:0;const P=W[A.BSe];if(0===G)return b.ULS.sendTraceTag(524940245,306,15,"FormulaByExampleManager.executeCommand: triggerFormulaByExample command called for execution with NoTrigger value."),this.Mp.yw(P,1),r.Task.Ua(!0);const E=!W||!W[A.b6c],H=this.qMh(W,E);W=!W||W[A.Xcf];E||2!==G&&!f.a.D5a(this.$)||
this.formulaByExampleManager.SSi(H,P,W);G=this.triggerFormulaByExample(H,E,P,W)}return G?r.Task.Ua(!0):k.a(T)}Ec(G,T){switch(T.command){case 1928326585:return f.a.Kec(this.$);default:return!1}}Vc(){return!1}qMh(G,T){b.ULS.sendTraceTag(537161928,306,50,`FormulaByExampleCommandHandler.getEditedRange: flow triggered from: ${T?"Ribbon":"AutoDetect"}`);return T?this.gridView.ha.sa.activeCell:G[A.b6c]}triggerFormulaByExample(G,T,W,P){if(!this.augmentationLoopManager)return b.ULS.sendTraceTag(537161927,
306,10,"FormulaByExampleCommandHandler.TriggerFormulaByExample: augmentationLoopManager instance is null"),this.Mp.yw(W,13,{reason:"AugmentationLoopManager instance is null"}),!1;if(P){const E=this.gridView.Db.Xj(G,!1);if(!E)return b.ULS.sendTraceTag(537161925,306,15,"FormulaByExampleCommandHandler.TriggerFormulaByExample: table returned null for given edit range."),this.Mp.yw(W,13,{reason:"Table returned null for given edit range"}),!1;P=f.a.D5a(this.$)&&!f.a.b4(this.$);T=this.XNh(G,T,E,W,P)}else T=
this.WNh(G,W);if(!T)return this.Mp.yw(W,13,{reason:"Signal is null"}),!0;b.ULS.sendTraceTag(537161926,306,50,`FormulaByExampleCommandHandler.TriggerFormulaByExample: calling SubmitOperationSignal for flowId: ${W}.`);this.augmentationLoopManager.WSd(T);this.Mp.yw(W,12);this.QJ.lda(G,1);this.IB&&Object(u.e)("SIGNALSENT",W);return!0}XNh(G,T,W,P,E){const {examples:H,additionalInputs:F}=this.vIh(W,G);if(!H||0==H.length)return b.ULS.sendTraceTag(527496675,306,50,"FormulaByExampleCommandHandler.getFormulaByExampleSignalFromTable: column does not have any examples or any examples with inputs"),
null;G=this.KJh(W);if(!G)return null;T=Object(c.a)(new n,{formulasCount:1,examples:H,additionalInputs:F,columnNames:G,stateID:this.$.ea.r7a,invocationMethod:T?0:1,guid:P.toString(),supportedFunctions:{TEXTSPLIT:E,TEXTSLICE:E,FINDN:E,TEXTAFTER:E,TEXTBEFORE:E}});b.ULS.sendTraceTag(528758225,306,50,"FormulaByExampleCommandHandler.getFormulaByExampleSignalFromTable: signal generated.");return T}vIh(G,T){G=e.a(G);return this.yVe(G,T.left)}KJh(G){const T=[],W=G.name;var P=e.a(G);G=this.calcManager.I3a(G);
if(P&&G){P=P.left;for(let E of G)T.push({column:P,name:W+"[@["+E+"]]"}),P++;return T}b.ULS.sendTraceTag(524940244,306,15,`FormulaByExampleCommandHandler.getColumnNamesMapFromTable: failed to generate columnNames. is tableRange null: ${!P}, is colNamesCurrentTable null: ${!G}`);return null}WNh(G,T){var W=new d.Range(G.top-x.a.wEe,G.left-x.a.nah,G.bottom,G.right,!0,!0);G=this.yVe(W,G.left).examples;if(!G||0==G.length)return b.ULS.sendTraceTag(524940243,306,50,"FormulaByExampleCommandHandler.getFormulaByExampleSignalFromRange: column does not have any examples or any examples with inputs"),
null;W=this.JJh(W);T=Object(c.a)(new n,{formulasCount:1,examples:G,columnNames:W,stateID:this.$.ea.r7a,invocationMethod:1,guid:T.toString(),supportedFunctions:{TEXTSPLIT:!0,TEXTSLICE:!0,FINDN:!0,TEXTAFTER:!0,TEXTBEFORE:!0}});b.ULS.sendTraceTag(524940242,306,50,"FormulaByExampleCommandHandler.getFormulaByExampleSignalFromRange: signal generated.");return T}yVe(G,T){const W=[],P=[],E=this.gridView.kk("FormulaByExample.GetSignalExamplesFromTable",G);try{const H=G.right;G=!1;let F=[],N=null;for(;E.$$mn();){const J=
E.$$cu(),R=J.range.left;R===T?J.text&&(N=this.EBe(J)):(J.text&&(G=!0),F.push(this.EBe(J)));R===H&&(G&&(N?W.push({output:N,inputs:F}):P.length<this.Tyi&&P.push({output:null,inputs:F})),F=[],N=null,G=!1)}}finally{E&&E.dispose()}return{examples:W,additionalInputs:P}}JJh(G){const T=[];for(let W=G.left;W<=G.right;W++){const P={column:W,name:d.Range.uP(W)};T.push(P)}return T}EBe(G){let T;if(1===G.Cy.type){T=parseFloat(G.Cy.value);var W=this.calcManager.R$b(G.cell.Ek);Object(B.c)(W)?W=W.value.isDate?4:W.value.isTime?
5:1:(b.ULS.sendTraceTag(522840207,0,10,`FormulaByExampleCommandHandler.createAugLoopCell: CalcManager's getNumberFormat method failed on the given cell, falling back to number format. failureReason: ${W.reason}`),W=1)}else T=G.text,W=0;return Object.assign(new w.a,{row:G.range.top,column:G.range.left,displayText:G.text,rawValueJson:JSON.stringify(T),numberFormatCategory:W.toString()})}}Object(t.a)(K,"FormulaByExampleCommandHandler",null,[188])},1308:function(t,D,a){a.r(D);a.d(D,"FormulaByExampleAutoSuggestActor",
function(){return u});t=a(0);var c=a(15),b=a(24),d=a(162),f=a(929),e=a(90),k=a(21),l=a(813),m=a(1272),v=a(36),n=a(969),w=a(848),r=a(1);class u{constructor(x,z,B){this.IB=!1;this.ONa=(y,A)=>{if(A.Cpb){y=A.Bk;var K=this.gridView.Db.JLa(y);if(K||v.a.D5a(this.$)){if(r.EwaSettings.isChangeGateEnabled("OfficeVSO:6649480_FormulaByExampleFlowAggregator")&&K){const G=this.gridView.Db.Xj(y,!1);this.Mp.yBf(G.name,y.left-(G.displayRtl?G.usedRange.right:G.usedRange.left))}switch(this.OYh(A,K)){case 0:this.yAb=
null;this.Mp.yw(w.b,1);break;default:K&&(this.Mp.yw(w.b,3),this.yAb=A.Bk,this.Trd||(this.calcManager.WDg(this.sCf),this.Trd=!0))}}else this.yAb=null}else this.yAb=null};this.sCf=(y,A)=>{A.Bk.equals(this.yAb)?(this.triggerFormulaByExample(2,!0,this.yAb),this.calcManager.jaj(this.sCf),this.Trd=!1):this.Mp.yw(w.b,2)};this.$=x;this.gridView=k.g(x);this.calcManager=z;this.IB=B;this.Trd=!1;this.gridView.Wb.jm(this.ONa);this.Mp=w.a.getInstance(x)}triggerFormulaByExample(x,z,B){const y=this.Mp.KZe();c.ULS.sendTraceTag(537161929,
306,50,`FormulaByExampleAutoSuggestActor.OnEndEdit: triggering FormulaByExample for cell edit. Trigger kind: ${x}, FlowId: ${y}`);this.IB&&Object(l.e)("EDITCOMMIT",y);const A=new e.a(1928326585,1,2,6,null);this.$.Ka.Lb(A,{[m.b.b6c]:B,[m.b.HVd]:x,[m.b.BSe]:y,[m.b.Xcf]:z})}OYh(x,z){const B=x.Bk,y=this.gridView.Xb(B);if(!y)return c.ULS.sendTraceTag(524120778,306,15,`FormulaByExampleAutoSuggestActor.getTriggerKindForInput: formattedCell is null. investigation hints: is editRange null = ${!B}`),0;x=this.calcManager.ahi(y.cell.Ek,
x.Nob);return null===x||x?0:z?this.gridView.Db.Pef(B)?0:this.vkj(B):this.ukj(B)}vkj(x){var z=this.gridView.Db.Xj(x,!1);z=d.a(z);x=x.left;x=new b.Range(z.top,x,z.bottom,x,!0,!0);return this.IVf(x,"FormulaByExampleAutoSuggestActor:Table")}ukj(x){const z=x.left;x=new b.Range(x.top-f.a.wEe,z,x.bottom,z,!0,!0);return this.IVf(x,"FormulaByExampleAutoSuggestActor:Range")}IVf(x,z){var B;let y=new Set,A=0;x=this.gridView.kk(z,x);try{for(;x.$$mn();){const K=x.$$cu();if(null===(B=K.Cy)||void 0===B?0:B.value)if(y.add(K.Cy.value),
A++,y.size>=n.a)return 2}}finally{x&&x.dispose()}A>=n.a&&c.ULS.sendTraceTag(523368219,306,50,"FormulaByExampleAutoSuggestActor.searchForSufficientExamplesInOutputColumn: Table has sufficient example amount - but not enough distinct examples.");return 0}}Object(t.a)(u,"FormulaByExampleAutoSuggestActor",null,[])},1426:function(t,D,a){function c(ra){return void 0===ra?"undefined":`${null===ra||void 0===ra?void 0:ra.Xluid}/${null===ra||void 0===ra?void 0:ra.Xrevid}@${null===ra||void 0===ra?void 0:ra.DocId}`}
a.r(D);t=a(0);var b=a(7),d=a(15),f=a(98);D=a(220);class e{}Object(t.a)(e,"WorkbookCoauthVersion",null,[]);var k=a(38);class l{constructor(){this.stateId=0;this.qYd=null}}Object(t.a)(l,"StateIdChangedInfo",null,[]);var m=a(62);const v=(ra,Qa,qb,Wa,ta,ib,Bb=null)=>{Bb=ra.Na(1,Bb);Bb.isObserverRequired=Qa;return m.g(ra,"ObserverRequiredNotification",Bb,qb,Wa,ta,ib,0)};class n extends Sys.EventArgs{constructor(ra,Qa,qb,Wa){super();this.kJ=ra;this.parentPath=qb;this.operationType=Wa}}Object(t.a)(n,"AnnotationReceivedEventArgs",
Sys.EventArgs,[]);var w=a(28),r=a(118),u=a(1);class x{constructor(){this.stateUpdateHandler=this.handler=this.config=this.annotationType=null}}Object(t.a)(x,"ActivateAnnotationParameters",null,[]);class z{constructor(){this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.userListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.metadataVersion=this.ecsOperationUrl=this.ecsRestUrl=this.ecsSessionId=this.wacCluster=null}}Object(t.a)(z,"ExcelServerParameters",
null,[]);class B{constructor(){this.excelServerParameters=null}}Object(t.a)(B,"ForceReconnectParameters",null,[]);class y{constructor(){this.workflow=null}}Object(t.a)(y,"RegisterLocalWorkflowParameters",null,[]);class A{constructor(){this.handler=null}}Object(t.a)(A,"SetAnnotationResultCallbackParameters",null,[]);class K{constructor(){this.message=null}}Object(t.a)(K,"SubmitCustomMessageParameters",null,[]);class G{constructor(){this.operation=null}}Object(t.a)(G,"SubmitOperationParameters",null,
[]);var T=a(720),W=a(966),P=a(748),E=a(694);class H extends P.a{constructor(){super();this.H_=Object.assign(new E.a,{T_:H.getTypeName(),B_:H.Od()})}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static Od(){return["AugLoop_Core_Operation"]}}Object(t.a)(H,"DeleteOperation",P.a,[]);class F extends P.a{constructor(){super();this.isFocused=!1;this.H_=Object.assign(new E.a,{T_:F.getTypeName(),B_:F.Od()})}static getTypeName(){return"AugLoop_Core_FocusOperation"}static Od(){return["AugLoop_Core_Operation"]}}
Object(t.a)(F,"FocusOperation",P.a,[]);var N=a(863),J=a(967);class R extends J.a{constructor(){super();this.prevParentPath=null;this.H_=Object.assign(new E.a,{T_:R.getTypeName(),B_:R.Od()})}static getTypeName(){return"AugLoop_Core_MoveOperation"}static Od(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}}Object(t.a)(R,"MoveOperation",J.a,[]);var M=a(965);class L extends P.a{constructor(){super();this.M_=null;this.H_=Object.assign(new E.a,{T_:L.getTypeName(),B_:L.Od()})}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static Od(){return["AugLoop_Core_Operation"]}}
Object(t.a)(L,"UpdateAnnotationMetaDataOperation",P.a,[]);var U=a(968);class X extends P.a{constructor(){super();this.isVisible=!1;this.H_=Object.assign(new E.a,{T_:X.getTypeName(),B_:X.Od()})}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static Od(){return["AugLoop_Core_Operation"]}}Object(t.a)(X,"VisibilityOperation",P.a,[]);var da=a(715);class fa extends da.a{constructor(){super();this.cv=this.messageId=null;this.H_=Object.assign(new E.a,{T_:fa.getTypeName(),B_:fa.Od()})}static getTypeName(){return"AugLoop_Session_Protocol_Message"}static Od(){return[]}}
Object(t.a)(fa,"Message",da.a,[]);class S extends fa{constructor(){super();this.H_=Object.assign(new E.a,{T_:S.getTypeName(),B_:S.Od()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelKeepAlive"}static Od(){return["AugLoop_Session_Protocol_Message"]}}Object(t.a)(S,"ExcelKeepAlive",fa,[]);class ka extends T.a{constructor(){super();this.isObserverRequired=this.isSeedingRequired=!1;this.H_=Object.assign(new E.a,{T_:ka.getTypeName(),B_:ka.Od()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation"}static Od(){return["AugLoop_Core_Annotation"]}}
Object(t.a)(ka,"ObserverStatusAnnotation",T.a,[]);class V extends fa{constructor(){super();this.parentPath=this.opType=this.seq=this.item=null;this.H_=Object.assign(new E.a,{T_:V.getTypeName(),B_:V.Od()})}static getTypeName(){return"AugLoop_Session_Protocol_MicroSyncMessage"}static Od(){return["AugLoop_Session_Protocol_Message"]}}Object(t.a)(V,"MicroSyncMessage",fa,[]);class wa extends da.a{constructor(){super();this.id=null;this.sizeBytes=0;this.dataPointer=this.data=null;this.H_=Object.assign(new E.a,
{T_:wa.getTypeName(),B_:wa.Od()})}static getTypeName(){return"AugLoop_Core_Blob"}static Od(){return[]}}Object(t.a)(wa,"Blob",da.a,[]);class ma extends wa{constructor(){super();this.format=0;this.otherFormat=null;this.size=0;this.isOriginalSize=null;this.H_=Object.assign(new E.a,{T_:ma.getTypeName(),B_:ma.Od()})}static getTypeName(){return"AugLoop_Image_ImageContent"}static Od(){return["AugLoop_Core_Blob"]}}Object(t.a)(ma,"ImageContent",wa,[]);class ab extends da.a{constructor(){super();this.heightPx=
this.widthPx=0;this.H_=Object.assign(new E.a,{T_:ab.getTypeName(),B_:ab.Od()})}static getTypeName(){return"AugLoop_Image_ImageTileMetadata"}static Od(){return[]}}Object(t.a)(ab,"ImageTileMetadata",da.a,[]);class ba extends ab{constructor(){super();this.contents=null;this.H_=Object.assign(new E.a,{T_:ba.getTypeName(),B_:ba.Od()})}static getTypeName(){return"AugLoop_Image_ImageTile"}static Od(){return["AugLoop_Image_ImageTileMetadata"]}}Object(t.a)(ba,"ImageTile",ab,[]);var Ca=a(99);class Na{constructor(){this.annotations=
new Set}poj(ra){this.tJ=ra;return this}activateAnnotation(ra){if(this.annotations.has(ra))throw ra=`Annotation from type ${ra.annotationType} was already activated`,d.ULS.sendTraceTag(521216417,0,10,`AugmentationLoopFeatureRegistrationInfoBuilder.activateAnnotation: ${ra}`),Error(ra);this.annotations.add(ra);return this}ppj(){this.featureName="FormulaByExample";return this}build(){if(void 0===this.tJ)throw d.ULS.sendTraceTag(521216416,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Close callback is not set"),
Error("Close callback is not set");if(0===this.annotations.size)throw d.ULS.sendTraceTag(521216415,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: No annotations were activated"),Error("No annotations were activated");if(!this.featureName)throw d.ULS.sendTraceTag(521216414,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Feature Name is not set"),Error("Feature Name is not set");return{featureName:this.featureName,tJ:this.tJ,annotations:this.annotations}}}Object(t.a)(Na,"AugmentationLoopFeatureRegistrationInfoBuilder",
null,[807]);class za extends k.a{constructor(ra,Qa,qb,Wa=null){var ta;super();this.yla=null;this.isObserverRequired=!1;this.hf=null;this.qXa=[];this.QRc=new Set;this.Tkc=[];this.Skc=new Map;this.NYb=[];this.Ovh=new Map([[1,1],[2,2],[3,3]]);this.IBc=new e;this.Xc=(ib,Bb)=>{Bb.zH&&this.$.ea.sessionId&&(d.ULS.sendTraceTag(537170394,0,50,`AugmentationLoopManager.onSessionIdChanged: Update augmentation loop server on new ECS Session ID: '${this.$.ea.sessionId}'`),this.iT.forceReconnectSession(Object(b.a)(new B,
{excelServerParameters:Object(b.a)(new z,{wacCluster:this.$.ya.MachineCluster,ecsSessionId:this.$.ea.sessionId,ecsRestUrl:this.$.ya.RestActionUrl,ecsOperationUrl:"",metadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,userListVersion:0,collabStateId:0,accessToken:this.$.ya.AccessToken,accessTokenTTL:this.$.ya.AccessTokenValidTo.toString()})})).catch(Ub=>{d.ULS.sendTraceTag(526406272,0,50,`AugmentationLoopManager.onSessionIdChanged: forceReconnectSession promise rejected with error ${Ub}`)}),
d.ULS.sendTraceTag(528348225,0,50,`AugmentationLoopManager.onSessionIdChanged: sending ObserverRequiredNotification, isSeedingRequired: ${this.isObserverRequired}`),this.Itc(this.isObserverRequired))};this.glc=(ib,Bb)=>{d.ULS.sendTraceTag(520679431,0,50,"AugmentationLoopManager.onCloseMessage called");if(ib){this.iT.startNewSession();for(const Ub of this.qXa)this.vlb(Ub)}else this.qXa.some(Ub=>!Ub.mfc)||this.kxc(),ib=this.Nvh(Bb),this.Bue(ib),this.SXc(),3===ib&&(this.iT.startNewSession(),this.qXa.filter(Ub=>
!Ub.mfc).forEach(Ub=>this.vlb(Ub))),u.EwaSettings.isChangeGateEnabled("OfficeVSO:5948479_QuickSavesWhenAloneForAugloop")&&this.$.ea.sessionId&&(d.ULS.sendTraceTag(520679430,0,50,"AugmentationLoopManager.onCloseMessage: sending ObserverRequiredNotification, isSeedingRequired: false"),this.Itc(!1))};this.IPi=()=>{d.ULS.sendTraceTag(537170393,0,50,"AugmentationLoopManager.onRetryableCloseMessage called");for(let ib of this.QRc)this.activateAnnotation(ib)};this.TNi=()=>{d.ULS.sendTraceTag(537170392,0,
50,"AugmentationLoopManager.onNonRetryableCloseMessage called");this.kxc();this.SXc();u.EwaSettings.isChangeGateEnabled("OfficeVSO:5948479_QuickSavesWhenAloneForAugloop")&&this.$.ea.sessionId&&(d.ULS.sendTraceTag(528348224,0,50,"AugmentationLoopManager.onNonRetryableCloseMessage: sending ObserverRequiredNotification, isSeedingRequired: false"),this.Itc(!1))};this.Dc=(ib,Bb)=>{if(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6443180_AvoidOnWorkbookClosingOnSilentReload")&&Bb.eg)d.ULS.sendTraceTag(520677599,
0,50,"AugmentationLoopManager.onWorkbookClosing: event triggered due to silent reopen. Avoiding event with early return");else if(d.ULS.sendTraceTag(537170381,0,50,`AugmentationLoopManager.onWorkbookClosing: handler invoked
      (IsAppBeforeUnload == ${this.$.aLa}, IsAppUnloading == ${this.$.aD}.`),this.$.aLa||this.$.aD)this.kxc(),u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")&&this.Bue(4),this.SXc(),this.iT.closeSession().catch(Ub=>{d.ULS.sendTraceTag(526406240,0,50,`AugmentationLoopManager.onWorkbookClosing: closeSession promise rejected with error ${Ub}`)})};this.vFa=ib=>{d.ULS.sendTraceTag(537170380,0,50,"Annotation Received");if(ib)if(ib.items){var Bb;({value:Bb}=
this.yla.Cc(da.a.Uua(ib),0));if(0===Bb)d.ULS.sendTraceTag(537170377,0,10,"AugmentationLoopManager.annotationCallback: Operation Type not supported "+da.a.Uua(ib));else{var Ub=!0;for(const mb of ib.items){if(!mb){d.ULS.sendTraceTag(537170376,0,10,"AugmentationLoopManager.annotationCallback: Error in item");continue}if(!(da.a.Wxi(ib,[H.getTypeName()])||mb.body&&this.Gdi(mb.body))){d.ULS.sendTraceTag(537170375,0,10,"AugmentationLoopManager.annotationCallback: Body is either null or not an annotation.");
continue}if(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6530013_FilterOutAnnotationsAccordingToOwner")){var Ta=mb.source;if(this.NYb.includes(Ta)){d.ULS.sendTraceTag(520677597,0,50,`AugmentationLoopManager.annotationCallback: Filtered out annotation of owner ${Ta}`);continue}}Ta=da.a.Uua(mb.body);if(!Ta){d.ULS.sendTraceTag(523329624,0,50,"AugmentationLoopManager.annotationCallback: annotationType is null");continue}const Qb=mb.body;if(!Qb){d.ULS.sendTraceTag(523329623,0,50,"AugmentationLoopManager.annotationCallback: annotation is null");
continue}const Lb=new n(Qb,null,ib.parentPath,Bb);if(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6438832_NoTryCatchInAnnotationCallback"))Ub=this.h1f(Qb)&&Ub,d.ULS.sendTraceTag(576271178,0,50,`AugmentationLoopManager.annotationCallback: Triggering Event handler for Annotation ${Ta}. Should report: ${Ub}. ParentRevId: ${ib.parentRevId}`),u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")&&this.Bnb.Wii(Lb.kJ.id,ib.parentRevId)&&(this.raiseEvent(this.dud(Ta),
Lb,this),d.ULS.sendTraceTag(520677596,0,100,`AugmentationLoopManager.annotationCallback: raising newAnnotation event (annotation type: ${Ta})`)),this.Bnb.Okc(Ta,Lb,ib.parentRevId),this.raiseEvent(Ta,Lb,this);else try{Ub=this.h1f(Qb)&&Ub,d.ULS.sendTraceTag(576271178,0,50,`AugmentationLoopManager.annotationCallback: Triggering Event handler for Annotation ${Ta}. Should report: ${Ub}. ParentRevId: ${ib.parentRevId}`),this.Bnb.Okc(Ta,Lb,ib.parentRevId),this.raiseEvent(Ta,Lb,this)}catch(Jb){d.ULS.sendTraceTag(537170374,
0,10,`AugmentationLoopManager.annotationCallback: exception thrown for annotation of type ${da.a.Uua(mb.body)} message: ${Jb.message}`)}}this.Ghc&&Ub&&(ib=r.a(this.yh,this.Ghc.qYd),d.ULS.sendTraceTag(590906632,0,50,`AugmentationLoopManager.annotationCallback: Got valid annotation, time elapse from last state id(${this.Ghc.stateId}): ${ib}`))}}else d.ULS.sendTraceTag(537170378,0,10,"AugmentationLoopManager.annotationCallback: Operation has no items");else d.ULS.sendTraceTag(537170379,0,10,"AugmentationLoopManager.annotationCallback: Operation is null")};
this.iy=(ib,Bb)=>{-1!==Bb.Jqf&&(this.Ghc=Object(b.a)(new l,{stateId:Bb.Jqf,qYd:this.yh.Nb}))};this.tla=()=>{const ib=r.b(this.yh,this.kAb),Bb=this.$.ea.x3,Ub=this.$.ea.k0;let Ta=this.lpf<=ib;u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.KeepAliveSuppressionTreatment",!1)&&(Ta&&(Ta=Ub<this.vSa),Ta&&(Ta=!Bb));Ta?(this.kAb=this.yh.Nb,d.ULS.sendTraceTag(520677595,0,50,`AugmentationLoopManager.onUserActivityThrottled: Submitting keepalive custom message. secondsSinceLastKeepAlive: ${ib}, timeInSecFromLastStatefulSuccessfulRequest: ${Ub}, deploymentOrTimedOutError: ${Bb}`),
this.iT.submitCustomMessage(Object(b.a)(new K,{message:new S})).catch(mb=>{d.ULS.sendTraceTag(526406239,0,50,`AugmentationLoopManager.onUserActivityThrottled: submitCustomMessage promise rejected with error ${mb}`)})):this.lpf<=ib&&d.ULS.sendTraceTag(520632032,0,50,`AugmentationLoopManager.onUserActivityThrottled: Not submitting keepalive custom message. secondsSinceLastKeepAlive: ${ib}, timeInSecFromLastStatefulSuccessfulRequest: ${Ub}, deploymentOrTimedOutError: ${Bb}`)};this.oxd=(ib,Bb)=>{ib=Bb.kJ;
d.ULS.shipAssertTag(537170373,306,!!ib,"AugmentationLoopManager.ObserverStatusAnnotationHandler: ObserverStatusAnnotation is null.");u.EwaSettings.isChangeGateEnabled("OfficeVSO:6621501_LogObserverStatusAnnotationReceivedDuringSilentReload")&&d.ULS.sendTraceTag(520677594,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: received ${JSON.stringify(ib)}`);this.isObserverRequired=ib.isSeedingRequired&&ib.isObserverRequired;this.$.ea.sessionId&&(d.ULS.sendTraceTag(520677593,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: sending ObserverRequiredNotification, isObserverRequired: ${this.isObserverRequired}`),
this.Itc(this.isObserverRequired))};this.rBa=(ib,Bb)=>{var Ub;(null===(Ub=null===Bb||void 0===Bb?void 0:Bb.$c)||void 0===Ub?0:Ub.WorkbookCoauthVersion)&&this.uTi(Bb.$c.WorkbookCoauthVersion,Bb.context)};this.yh=Wa||w.a.Wa;this.kAb=this.yh.Nb;this.$=ra;this.iT=Qa;this.Bnb=qb;d.ULS.sendTraceTag(520679433,0,50,`AugmentationLoopManager.constructor: setAnnotationResultCallback : ${null===(ta=this.vFa)||void 0===ta?void 0:ta.name}`);this.iT.setAnnotationResultCallback(Object(b.a)(new A,{handler:this.vFa}));
this.D$h();this.$.ea.kE(this.iy);this.$.ik(this.Dc);this.Ghc=Object(b.a)(new l,{stateId:0,qYd:this.yh.Nb});this.$.da.Ga(328,this);this.lpf=this.$.ya.MinimumSecondsBetweenKeepAlivesFromBrowserToAugloop;this.vSa=60*this.$.ya.UserActiveTimeSinceLastActivityInMinutes;this.$.ea.hk(this.Xc);this.$.pa.Gr(this.rBa);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6530013_FilterOutAnnotationsAccordingToOwner")&&this.p8h();this.Syg();this.Jyg()}p8h(){u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableLintBatchLoad",
!1)?this.NYb.push("TableLint-Grid-Column"):this.NYb.push("Tablelint-Column");u.EwaSettings.isChangeGateEnabled("OfficeVSO:7001231_IgnoreXlimVNextAnnotations")&&this.NYb.push("ExcelTableRecognitionReducer")}tHh(){return new Na}register(ra){this.Skc.set(ra.featureName,ra.tJ);for(const Qa of ra.annotations)this.vlb(Object.assign(Object.assign({},Qa),{featureName:ra.featureName})),Qa.uCb&&this.uke(Qa.annotationType,Qa.uCb),Qa.sYd&&this.L1.$O("Valid",Qa.annotationType,Qa.sYd),Qa.xkd&&this.L1.$O("Invalid",
Qa.annotationType,Qa.xkd)}unregister(ra){this.Skc.delete(ra);this.qXa.filter(Qa=>Qa.featureName===ra).forEach(Qa=>{Qa.uCb&&this.V9i(Qa.annotationType,Qa.uCb);Qa.sYd&&this.L1.pPa("Valid",Qa.annotationType,Qa.sYd);Qa.xkd&&this.L1.pPa("Invalid",Qa.annotationType,Qa.xkd)})}fXb(ra){this.Tkc.push(ra);d.ULS.sendTraceTag(520679432,0,50,`AugmentationLoopManager.addCloseCallback: ${null===ra||void 0===ra?void 0:ra.name}`)}Nvh(ra){var Qa;return null!==(Qa=this.Ovh.get(ra))&&void 0!==Qa?Qa:0}dud(ra){return`New_${ra}ALManager`}uke(ra,
Qa){d.ULS.sendTraceTag(520679429,0,50,`AugmentationLoopManager.addNewAnnotationCallback: annotationType: ${ra}, handler: ${null===Qa||void 0===Qa?void 0:Qa.name}`);this.addHandler(this.dud(ra),Qa)}V9i(ra,Qa){this.removeHandler(this.dud(ra),Qa)}$O(ra,Qa){d.ULS.sendTraceTag(520679428,0,50,`AugmentationLoopManager.addAnnotationCallback: annotationType: ${ra}, handler: ${null===Qa||void 0===Qa?void 0:Qa.name}`);this.addHandler(ra,Qa)}pPa(ra,Qa){this.removeHandler(ra,Qa)}Lje(ra){d.ULS.sendTraceTag(520679427,
0,50,"AugmentationLoopManager.addCoauthVersionChangedCallback");this.addHandler("CoauthVersionChangedALManager",ra)}NNf(ra){d.ULS.sendTraceTag(520679426,0,50,"AugmentationLoopManager.removeCoauthVersionChangedCallback called");this.removeHandler("CoauthVersionChangedALManager",ra)}activateAnnotation(ra,Qa=null){d.ULS.sendTraceTag(537170390,0,50,`AugmentationLoopManager.activateAnnotation: activating annotation type: ${ra}.`);this.QRc.has(ra)&&d.ULS.sendTraceTag(537170389,0,50,`AugmentationLoopManager.activateAnnotation: Annotations ${ra} were already activated in client session.`);
this.QRc.add(ra);this.hf||(this.hf=this.$.ea.hf,this.hf.dra(this.tla));this.iT.activateAnnotation(Object(b.a)(new x,{annotationType:ra,stateUpdateHandler:Qa})).then(qb=>{qb||d.ULS.sendTraceTag(537170388,0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");return null}).catch(qb=>{d.ULS.sendTraceTag(526406243,0,50,`AugmentationLoopManager.activateAnnotation: activateAnnotation promise rejected with error ${qb}`)})}vlb(ra){d.ULS.sendTraceTag(520679425,0,50,`AugmentationLoopManager.activateAnnotation: activating annotation type: ${ra.annotationType}.`);
this.qXa.includes(ra)?d.ULS.sendTraceTag(520679424,0,50,`AugmentationLoopManager.activateAnnotation: Annotations ${ra.annotationType} were already activated in client session.`):this.qXa.push(ra);this.hf||(this.hf=this.$.ea.hf,this.hf.dra(this.tla));u.EwaSettings.isChangeGateEnabled("OfficeVSO:6044361_XLALCatchPromiseFailures")?this.iT.activateAnnotation(Object(b.a)(new x,{annotationType:ra.annotationType,stateUpdateHandler:ra.OIg})).then(Qa=>{Qa||d.ULS.sendTraceTag(520677603,0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");
return null}).catch(Qa=>{d.ULS.sendTraceTag(520677602,0,50,`AugmentationLoopManager.activateAnnotation: activateAnnotation promise rejected with error ${Qa}`)}):this.iT.activateAnnotation(Object(b.a)(new x,{annotationType:ra.annotationType,stateUpdateHandler:ra.OIg})).then(Qa=>{Qa||d.ULS.sendTraceTag(520677601,0,10,"AugmentationLoopManager.ActivateAnnotation: ActivateAnnotationsResult is null");return null})}submitOperation(ra){d.ULS.shipAssertTag(537170387,0,!!ra,"AugmentationLoopManager.submitOperation: operation is null");
d.ULS.sendTraceTag(537170386,0,50,`AugmentationLoopManager.submitOperation: submitting operation of type '${da.a.Uua(ra)}'`);this.iT.submitOperation(Object(b.a)(new G,{operation:ra}))}WSd(ra){d.ULS.shipAssertTag(537170385,0,!!ra,"AugmentationLoopManager.submitOperationSignal: signal is null");const Qa=Object.getTypeName(ra);d.ULS.sendTraceTag(537170384,0,50,`AugmentationLoopManager.submitOperationSignal: submitting operation signal of type '${Qa}'`);this.iT.submitOperation(Object(b.a)(new G,{operation:Object(b.a)(new M.a,
{parentPath:["Signal",Object.getTypeName(ra)],items:[Object(b.a)(new N.a,{body:ra})]})}))}registerLocalWorkflow(ra){d.ULS.shipAssertTag(537170383,0,!!ra,"AugmentationLoopManager.registerLocalWorkflow: workflow is null");d.ULS.sendTraceTag(537170382,0,50,`AugmentationLoopManager.registerLocalWorkflow: registering local workflow '${ra.id}'`);this.iT.registerLocalWorkflow(Object(b.a)(new y,{workflow:ra}))}GTj(ra,Qa,qb,Wa){ra=Object(b.a)(new ba,{heightPx:Wa,widthPx:qb,contents:[Object(b.a)(new ma,{id:Qa+
".0",format:2,size:3,sizeBytes:ra.length,data:ra})]});Qa=Object(b.a)(new N.a,{id:Qa,body:ra});Qa=Object(b.a)(new V,{item:Qa});d.ULS.sendTraceTag(520677600,0,50,"AugmentationLoopManager.uploadImage: submitting custom message");this.iT.submitCustomMessage(Object(b.a)(new K,{message:Qa})).catch(ta=>{d.ULS.sendTraceTag(526406241,0,50,`AugmentationLoopManager.uploadImage: submitCustomMessage promise rejected with error ${ta}`)})}get L1(){return this.Bnb}dispose(){this.$&&this.$.ea&&this.$.ea.Hk(this.Xc);
this.$&&this.$.pa&&this.$.pa.qt(this.rBa);this.Tkc=[];this.Skc.clear();this.kxc();super.dispose()}kxc(){this.hf&&(this.hf.zPa(this.tla),this.hf=null);this.$.ea.CD(this.iy)}SXc(){for(let ra of this.Tkc)try{ra()}catch(Qa){d.ULS.sendTraceTag(528016151,0,10,`AugmentationLoopManager.callAndClearAugloopCloseCallbacks: exception thrown at callback invocation with message: ${Qa.message}`)}this.Tkc=[]}Bue(ra){for(const Qa of this.Skc.values())try{Qa(ra,void 0)}catch(qb){d.ULS.sendTraceTag(520677598,0,10,String.format(`AugmentationLoopManager.callAndClearAugloopCloseCallbacks: exception thrown at callback invocation with message: ${qb.message}`))}}D$h(){this.yla=
new Ca.a;this.yla.ia(W.a.getTypeName(),1);this.yla.ia(U.a.getTypeName(),2);this.yla.ia(R.getTypeName(),5);this.yla.ia(H.getTypeName(),3);this.yla.ia(X.getTypeName(),7);this.yla.ia(F.getTypeName(),6);this.yla.ia(L.getTypeName(),4)}Gdi(ra){return da.a.Uua(ra)===T.a.getTypeName()||0<=Array.indexOf(da.a.rVe(ra),T.a.getTypeName())}h1f(ra){if(ra){if(u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.AutoCLPV2Transition",!1)){var Qa=!!ra.recommended&&!!ra.recommended.id;return!!ra.automatic&&
!!ra.automatic.id||Qa}Qa=!!ra.recommended&&!!ra.recommended.sensitivityLabel&&!!ra.recommended.sensitivityLabel.id;return!!ra.automatic&&!!ra.automatic.sensitivityLabel&&!!ra.automatic.sensitivityLabel.id||Qa}return!1}Jyg(){u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1)&&(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")?this.vlb({annotationType:"AugLoop_UnitTelemetry_UnitTelemetryAggregatedAnnotation",mfc:!0}):
this.activateAnnotation("AugLoop_UnitTelemetry_UnitTelemetryAggregatedAnnotation"))}Syg(){u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")?(this.vlb({annotationType:ka.getTypeName(),mfc:!0,uCb:this.oxd}),this.uke(ka.getTypeName(),this.oxd)):(this.activateAnnotation(ka.getTypeName()),this.$O(ka.getTypeName(),this.oxd))}Itc(ra){v(this.$.pa.va,ra,null,null,null,null)}uTi(ra,Qa){if(this.IBc.DocId!==ra.DocId||this.IBc.Xluid!==ra.Xluid&&this.IBc.Xrevid!==
ra.Xrevid)this.IBc=ra,u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")&&this.raiseEvent("CoauthVersionChangedALManager",{coauthVersion:ra,userContext:Qa},this),this.Bnb.tTi(ra,Qa.userContext)}}Object(t.a)(za,"AugmentationLoopManager",k.a,[780,3]);var la=a(4),aa=a(382),sa=a(192),ea=a(146),Z=a(29),ua=a(84),ya=a(54);class ha{constructor(){this.powerpoint=this.downloadPolymerBaseUrl=this.inferenceServiceVersion=this.downloadBaseUrl=this.sessionCreationOptions=
this.disabledServiceGroups=this.privateMode=this.flights=this.excelServer=this.initSession=this.sessionId=this.releaseFork=this.releaseChannel=this.releaseAudienceGroup=this.uiLanguage=this.appVersion=this.appName=this.serviceUrl=null}}Object(t.a)(ha,"InitializeParameters",null,[]);class Da{constructor(){this.networkMode=this.egress=this.localRegisteredWorkflows=this.enableComplexLocalWorkflows=this.serviceUrl=this.onSessionClose=this.onSessionReconnect=this.onSessionDisconnect=this.onSessionConnect=
this.flights=this.extensionConfigs=this.docSessionId=null}}Object(t.a)(Da,"SessionCreationOptions",null,[]);class nb{constructor(){this.featureEnabledCallback=null}}Object(t.a)(nb,"SetIsFeatureEnabledCallbackParameters",null,[]);class qa{constructor(){this.requestAuthTokenCallback=null}}Object(t.a)(qa,"SetRequestAuthTokenCallbackParameters",null,[]);class pa{constructor(){this.sendOTelEvent=null}}Object(t.a)(pa,"SetSendOTelEventCallbackParameters",null,[]);class Ja{constructor(){this.handler=null}}
Object(t.a)(Ja,"SetSessionInitOverrideCallbackParameters",null,[]);class $a{constructor(){this.ulsLogger=null}}Object(t.a)($a,"SetULSLoggerParameters",null,[]);class rb extends da.a{constructor(){super();this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.collabUserListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.workbookMetadataVersion=this.ecsOperationUrl=this.restUrl=this.ecsId=this.cluster=null;this.H_=Object.assign(new E.a,
{T_:rb.getTypeName(),B_:rb.Od()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelServerSessionExtensionConfig"}static Od(){return[]}}Object(t.a)(rb,"ExcelServerSessionExtensionConfig",da.a,[]);var Pa=a(861),eb=a(195);class Ob{static Bri(ra,Qa,qb){if(Ob.FZb)return d.ULS.sendTraceTag(537170369,0,15,"augloop: LoadAndInitializeAugLoopRuntimeManager called more than once"),Ob.FZb;const Wa=la.AFrameworkApplication.fa.Va("AugLoopCloudALServiceUrl");if(!Wa||!Wa.length)return d.ULS.sendTraceTag(537170368,
0,15,"AugmentationLoopRuntimeProxy.LoadAndInitializeAugLoopRuntimeManager: AugLoopCloudALServiceUrl is null or empty"),Promise.reject(null);qb=eb.a(ya.a.loadScript(82,4,qb,void 0,void 0,327));Ob.FZb=qb.then(()=>{const ta=augLoop.ALFactoryGlobal.getAugLoopRuntimeManager();Ob.t9h(ra,Qa,ta);return Promise.resolve(ta)}).catch(ta=>{d.ULS.sendTraceTag(537170339,0,10,"augloop: Failed to download script:"+ta);return Promise.reject(null)});return Ob.FZb}static t9h(ra,Qa,qb){var Wa;d.ULS.sendTraceTag(537170338,
0,50,"augloop: Successfully loaded script");Ob.yh||Ob.ooj(w.a.Wa);Ob.lmd=new Set;d.ULS.sendTraceTag(522803219,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: setIsFeatureEnabledCallback");qb.setIsFeatureEnabledCallback(Object(b.a)(new nb,{featureEnabledCallback:ta=>{const ib=la.AFrameworkApplication.fa.qa("AugLoop"+ta),Bb=u.EwaSettings.getBooleanFeatureGate(ta,!1),Ub=u.EwaSettings.getBooleanFeatureGate("AugLoop"+ta,!1),Ta=Bb||Ub,mb=ib||Ta;Ob.lmd.has(ta)||(Ob.lmd.add(ta),d.ULS.shipAssertTag(537170337,
0,!(ib&&!Ta),`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager.isFeatureEnabled: legacy app setting return true for feature ${ta}, but feature gate return false. This is problem because app setting is depricated and about to be removed`),mb&&d.ULS.sendTraceTag(537170336,0,50,`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager.isFeatureEnabled: feature ${ta} is enabled. legacyAppSettingResult: ${ib}, featureGateWithoutPrefix: ${Bb}, featureGateWithPrefix: ${Ub}`));return mb}}));
if(u.EwaSettings.ma(432))if(Qa){let ta=Ob.r9b(Qa);ta=Ob.r9b(Qa,la.AFrameworkApplication.fa.Va("AugloopACLPUserDataSignature"));d.ULS.sendTraceTag(522803218,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: Callback is passed to the augloop runtime which calls the code  when an auth token is required");qb.setRequestAuthTokenCallback(Object(b.a)(new qa,{requestAuthTokenCallback:ta}))}else d.ULS.sendTraceTag(537170335,0,10,"Oauth manager is null");d.ULS.sendTraceTag(522803217,0,50,
"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setULSLogger");qb.setULSLogger(Object(b.a)(new $a,{ulsLogger:new aa.a}));d.ULS.sendTraceTag(522803216,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSendOTelEventCallback");qb.setSendOTelEventCallback(Object(b.a)(new pa,{sendOTelEvent:Ob.sendOTelEvent}));Qa="";u.EwaSettings.ma(434)&&(Qa+="AugmentationLoopObserverSession;");u.EwaSettings.ma(484)&&(Qa+="AugmentationLoopIncrementalUpdates;");
u.EwaSettings.ma(440)&&(Qa+="EnterpriseDataTypeMipSupport;");if(u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintExperiment",!1)||u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintProdExperiment",!1)||u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligence",!1)||u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1))Qa+="LoadAdditionalDataToModel;";u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.DataCleansingTaskPane",
!1)&&(Qa+="DataCleansingSlice0;LoadAdditionalDataToModel;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopNoLatency",!1)&&(Qa+="AugloopNoLatency;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableLintInvestigationTelemetry",!1)&&(Qa+="TableLintInvestigationTelemetry;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TelemetryWorkflowIncludeTextHints",!1)&&(Qa+="TelemetryWorkflowIncludeTextHints;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.Insights.UseTableRecoMLTableIntelligence",
!1)&&(Qa+="UseTableRecoMLTableIntelligence;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceLogging",!1)&&(Qa+="TableIntelligenceLogging;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopWaitForWorkbookChangeState",!1)&&(Qa+="AugloopWaitForWorkbookChangeState;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceSheetCountThreshold",!1)&&(null===(Wa=null===ra||void 0===ra?void 0:ra.xa)||void 0===Wa?0:Wa.count)&&ra.xa.count>
u.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.TableIntelligenceSheetCountThresholdValue",100)&&(Qa+="TableIntelligenceSheetCountThreshold;",d.ULS.sendTraceTag(521151777,306,50,`TableIntelligence max sheet count exceeded. SheetCount: ${ra.xa.count}`));Wa=u.EwaSettings.OLh();for(const ta of Wa)Qa+=`${ta}=false;`;d.ULS.sendTraceTag(522803215,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setInitSessionCallback");qb.setInitSessionCallback({initSessionCallback:()=>
{var ta;if(null===(ta=null===ra||void 0===ra?void 0:ra.ea)||void 0===ta?0:ta.sessionId)return d.ULS.sendTraceTag(527708568,0,50,`AugmentationLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is valid (length = ${ra.ea.sessionId.length}), return resolved promise`),Promise.resolve();d.ULS.sendTraceTag(527708567,0,50,"AugmentationLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is not valid, return promise that will be resolved when session id will be valid again.");
return new Promise(ib=>{var Bb;const Ub=()=>{var Ta;(null===(Ta=null===ra||void 0===ra?void 0:ra.ea)||void 0===Ta?0:Ta.sessionId)?(d.ULS.sendTraceTag(527708566,0,50,`AugmentationLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called with valid session id (length = ${ra.ea.sessionId.length}), resolve the promise and unregister the callback.`),ra.ea.Hk(Ub),ib()):d.ULS.sendTraceTag(527708565,0,50,"AugmentationLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called, but the session id is not valid yet, keep waiting.")};
null===(Bb=null===ra||void 0===ra?void 0:ra.ea)||void 0===Bb?void 0:Bb.hk(Ub)})}});d.ULS.sendTraceTag(522803214,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSessionInitOverrideCallback");qb.setSessionInitOverrideCallback(Object(b.a)(new Ja,{handler:ta=>{ta.extensionConfigs=[Object(b.a)(new rb,{cluster:ra.ya.MachineCluster,ecsId:Ob.mMh(ra),restUrl:ra.ya.RestActionUrl,ecsOperationUrl:"",workbookMetadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,
collabUserListVersion:0,collabStateId:0,accessToken:ra.ya.AccessToken,accessTokenTTL:ra.ya.AccessTokenValidTo.toString()})];d.ULS.sendTraceTag(537170334,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: access token TTL "+ra.ya.AccessTokenValidTo.toString());return ta}}));d.ULS.sendTraceTag(522803213,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.initialize - onSessionClose: getOnCloseMessageCallback ");qb.initialize(Object(b.a)(new ha,{serviceUrl:la.AFrameworkApplication.fa.Va("AugLoopCloudALServiceUrl"),
appName:"Excel",appVersion:la.AFrameworkApplication.fa.Va("BuildVersion")||"",releaseAudienceGroup:la.AFrameworkApplication.Rb?Object(ua.a)(String,la.AFrameworkApplication.Rb.AudienceGroup)||"":"",releaseChannel:null,releaseFork:null,sessionId:ra.ya.UserSessionId,initSession:!0,flights:Qa,uiLanguage:la.AFrameworkApplication.uiCulture,excelServer:null,sessionCreationOptions:u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")?Object(b.a)(new Da,{onSessionClose:Ob.d_e()}):
Object(b.a)(new Da,{onSessionClose:Ob.d_e(qb)})}))}static d_e(ra){return Qa=>{var qb,Wa;let ta=!sa.a.instance.CQ(la.AFrameworkApplication.gk);if(ta)if(Qa)if(Qa.reason){const ib=Qa.reason;d.ULS.shipAssertTag(537170333,0,!(void 0===ib.isRetryableError||null===ib.isRetryableError),"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: closeReason.IsRetryableError is null");ta=(null==ib.isRetryableError?!0:ib.isRetryableError)&&ta}else d.ULS.sendTraceTag(537170332,0,15,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: closeMessage.Reason is null");
else d.ULS.shipAssertTag(537170331,0,!1,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: - closeMessage is null");else d.ULS.sendTraceTag(537170330,0,15,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: access token has expired");d.ULS.sendTraceTag(537170329,0,15,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: On close message callback is called. shouldRetry is set to ${ta}`);ta&&((!Ob.sMb||r.a(Ob.yh,Ob.sMb)>Ob.KLf)&&Ob.sfj(),Ob.Npc<Ob.wud?(Ob.Npc++,d.ULS.sendTraceTag(537170328,
0,50,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: Start new session attempt ${Ob.Npc} of ${Ob.wud}. Time of first attempt in this interval of reconnects: ${Ob.sMb}`)):(d.ULS.sendTraceTag(537170327,0,15,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: Reached the limit of ${Ob.wud} attempts for session creation under interval of ${Ob.KLf} Ms. Stop trying to reconnect. Time of first attempt in this iterval: ${Ob.sMb}.`),ta=!1));u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")?
Ob.fuf(ta,null===(qb=null===Qa||void 0===Qa?void 0:Qa.reason)||void 0===qb?void 0:qb.errorType,null===(Wa=null===Qa||void 0===Qa?void 0:Qa.reason)||void 0===Wa?void 0:Wa.errorCode):ta?(ra.startNewSession(),Ob.CAf()):Ob.$yf()}}static Qqj(ra){Ob.$yf=ra}static Frj(ra){Ob.CAf=ra}static qoj(ra){Ob.fuf=ra}static ooj(ra){Ob.yh=ra}static sfj(){Ob.Npc=0;Ob.sMb=Ob.yh.Nb}static r9b(ra,Qa=""){return()=>{try{return d.ULS.sendTraceTag(527970953,0,50,`AugmentationLoopRuntimeProxy.getAuthTokenDelegate: called with fallbackValue.length: ${Qa.length}.`),
ra.uO("AugLoop",la.AFrameworkApplication.fa.Va("AugLoopOAuthResourceUriV2")).then(qb=>{if(qb.IsSuccess)return d.ULS.sendTraceTag(527970952,0,50,"AugmentationLoopRuntimeProxy.getAuthTokenDelegate: successfully fetch token."),qb.Token;d.ULS.sendTraceTag(537170326,0,15,`AugmentationLoopRuntimeProxy.getAuthTokenDelegate: failed to get token, use fallback value (length: ${Qa.length})`);return Qa},()=>{d.ULS.sendTraceTag(537170325,0,15,"AugmentationLoopRuntimeProxy.getAuthTokenDelegate: got rejected promise, use fallback value");
return Qa})}catch(qb){return d.ULS.sendTraceTag(537170324,0,10,"Exception thrown when fetching token"),Promise.resolve(Qa)}}}static sendOTelEvent(ra){ea.a.sendOtelEvent(Object(b.a)(new Pa.a,{otelEvent:ra}))}static mMh(ra){const Qa=Z.a.ef(ra.ea.sessionId);ra=u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.XLALReadMetadataFromUserEcsSession",!1)?`cluster=${ra.ya.MachineCluster}&session=${Qa}&usid=${ra.ya.UserSessionId}`:"";u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.XLALReadMetadataFromUserEcsSession",
!1)&&u.EwaSettings.isChangeGateEnabled("OfficeVSO:5897059_XLALInvestigateIncorrectSessionId")&&d.ULS.sendTraceTag(528348230,0,50,`AugmentationLoopRuntimeProxy.getEcsSessionId: ecsSessionId length is ${ra.length}`);return ra}}Ob.wud=3;Ob.KLf=3E5;Ob.Npc=0;Ob.sMb=null;Ob.yh=null;Ob.FZb=null;Ob.fuf=null;Ob.CAf=null;Ob.$yf=null;Ob.lmd=null;Object(t.a)(Ob,"AugmentationLoopRuntimeProxy",null,[]);var tb=a(50),cc=a(37),Ib=a(185),Mb;(function(ra){ra.newAnnotation="New";ra.validAnnotation="Valid";ra.invalidAnnotation=
"Invalid"})(Mb||(Mb={}));Object(t.b)("AnnotationCallbackType",Mb);var Oa;(function(ra){ra.newAnnotation="New";ra.validOnArrivalAnnotation="ValidOnArrival";ra.validAfterSomeTimeAnnotation="ValidAfterSomeTime";ra.invalidOnCoauthVersionChangedAnnotation="InvalidOnCoauthVersionChanged";ra.invalidAfterTimeoutAnnotation="InvalidAfterTimeout"})(Oa||(Oa={}));Object(t.b)("AnnotationEventType",Oa);var Aa;(function(ra){ra[ra.beforeAnnotation=0]="beforeAnnotation";ra[ra.atAnnotation=1]="atAnnotation";ra[ra.afterAnnotation=
2]="afterAnnotation"})(Aa||(Aa={}));Object(t.b)("TimelinePosition",Aa);class Ba{constructor(){this.Fdb=new Map;d.ULS.sendTraceTag(520176320,0,50,"AugmentationLoopAnnotationValidatorLogger.constructor: called")}Cje(ra){this.Fdb.has(ra)||(d.ULS.sendTraceTag(520176291,0,50,`AugmentationLoopAnnotationValidatorLogger.addAnnotationType: ${ra}`),this.Fdb.set(ra,[]))}f9i(ra){this.Fdb.delete(ra)&&d.ULS.sendTraceTag(520176290,0,50,`AugmentationLoopAnnotationValidatorLogger.removeAnnotationType: ${ra}`)}RNi(ra,
Qa){ra.find(qb=>qb.annotationId===Qa)||ra.push({annotationId:Qa,lJj:Date.now(),LYb:Oa.newAnnotation})}jui(ra,Qa,qb,Wa){d.ULS.sendTraceTag(520176289,0,50,`AugmentationLoopAnnotationValidatorLogger.logLatencyEntry: type: ${ra}, entry: (${Qa.annotationId} ${Qa.LYb}) incoming: ${Wa}, latency: ${qb-Qa.lJj} ms`)}x4h(ra,Qa,qb){return(qb===Oa.validAfterSomeTimeAnnotation||qb===Oa.validOnArrivalAnnotation)&&(ra.annotationId===Qa||ra.LYb===Oa.invalidAfterTimeoutAnnotation)}ESi(ra,Qa,qb,Wa){let ta=[];const ib=
Date.now();let Bb=Aa.beforeAnnotation;for(let Ub of Qa){this.x4h(Ub,qb,Wa)&&this.jui(ra,Ub,ib,Wa);if(Ub.annotationId===qb){Ub.LYb=Wa;if(Wa===Oa.invalidAfterTimeoutAnnotation)return;Bb=Aa.atAnnotation}else Bb===Aa.atAnnotation&&(Bb=Aa.afterAnnotation);Qa=Wa===Oa.invalidOnCoauthVersionChangedAnnotation?Ub.annotationId!==qb:Ub.LYb===Oa.newAnnotation;const Ta=Bb===Aa.afterAnnotation;(Bb!==Aa.afterAnnotation&&Qa||Ta)&&ta.push(Ub)}this.Fdb.set(ra,ta)}eFi(ra,Qa,qb){let Wa=this.Fdb.get(ra);Wa||(this.Cje(ra),
Wa=this.Fdb.get(ra));qb===Oa.newAnnotation?this.RNi(Wa,Qa):this.ESi(ra,Wa,Qa,qb)}}Object(t.a)(Ba,"AugmentationLoopAnnotationValidatorLogger",null,[]);class ob{constructor(ra,Qa){this.toString=()=>JSON.stringify(this);this.annotationId=ra;this.coauthVersion=Qa}}Object(t.a)(ob,"LocalAnnotationId",null,[]);class xb extends k.a{constructor(ra=36E5){super();this.lMa=new Map;this.CZ=new Map;this.QNa=new Set;this.BYd=new Ba;this.COb=u.EwaSettings.isChangeGateEnabled("OfficeVSO:6443102_AugmentationLoopAnnotationValidatorLogCallbackRegistration");
this.jni=u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown");this.gQe=ra;d.ULS.sendTraceTag(523337872,0,50,`AugmentationLoopAnnotationValidator.constructor: annotationExpirationTimeout: ${this.gQe} ms`)}dispose(){d.ULS.sendTraceTag(523337871,0,50,`AugmentationLoopAnnotationValidator.dispose: ${this.getStatus()}`);this.QNa.clear();this.CZ.clear();this.lMa.clear();super.dispose()}Lje(ra){this.COb&&d.ULS.sendTraceTag(521405910,0,50,"AugmentationLoopAnnotationValidator.addCoauthVersionChangedCallback");
this.addHandler("CoauthVersionChanged",ra)}NNf(ra){this.COb&&d.ULS.sendTraceTag(521405909,0,50,"AugmentationLoopAnnotationValidator.removeCoauthVersionChangedCallback");this.removeHandler("CoauthVersionChanged",ra)}$O(ra,Qa,qb){this.COb&&d.ULS.sendTraceTag(521405908,0,50,`AugmentationLoopAnnotationValidator.addAnnotationCallback: annotationType: ${Qa}`);this.addHandler(this.bud(ra,Qa),qb);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&this.BYd.Cje(Qa)}pPa(ra,
Qa,qb){this.COb&&d.ULS.sendTraceTag(521405907,0,50,`AugmentationLoopAnnotationValidator.removeAnnotationCallback: annotationType: ${Qa}`);this.removeHandler(this.bud(ra,Qa),qb);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&this.BYd.f9i(Qa)}tTi(ra,Qa){d.ULS.sendTraceTag(523337870,0,50,this.jni?`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: starting, raising CoauthVersionChanged event: ${c(ra)}`:`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: starting (${c(ra)})`);
this.raiseEvent("CoauthVersionChanged",{coauthVersion:ra,userContext:Qa},this);this.lci(this.Q3b);this.Q3b=ra;this.LUj(this.Q3b);this.y$e();d.ULS.sendTraceTag(523337869,0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: done ${this.getStatus()}`)}sQe(ra){if(ra)try{const ta=JSON.parse(ra);var Qa=ta.coauthVersionDocId,qb=ta.coauthVersionXluid,Wa=ta.coauthVersionXrevId;return{DocId:"undefined"===Qa?void 0:Qa,Xluid:"undefined"===qb?void 0:qb,Xrevid:"undefined"===Wa?void 0:parseInt(Wa,
10)}}catch(ta){d.ULS.sendTraceTag(523337868,0,10,`AugmentationLoopAnnotationValidator.extractWorkbookCoauthVersion(${ra}): Exception - ${ta}`)}}Okc(ra,Qa,qb){qb=this.sQe(qb);void 0!==qb&&(d.ULS.sendTraceTag(523337867,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: starting ${ra}: ${Qa.operationType}: (annotation id ${Qa.kJ.id}) at ${c(qb)}`),this.eBg({annotationType:ra,xoe:Qa},qb),this.y$e(),d.ULS.sendTraceTag(523337866,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: done ${this.getStatus()}`))}bud(ra,
Qa){return`${ra}_${Qa}`}getStatus(){var ra,Qa;const qb=c(this.Q3b),Wa=null===(ra=this.lMa)||void 0===ra?void 0:ra.size;ra=null===(Qa=this.QNa)||void 0===Qa?void 0:Qa.size;return`current coauth version: ${qb}, ${Wa} known annotations, ${ra} coauth versions on hold`}fGb(ra,Qa,qb,Wa){const ta=this.lMa.get(`${Qa}`);ra=this.bud(ra,ta.annotationType);d.ULS.sendTraceTag(523337865,0,50,`AugmentationLoopAnnotationValidator.raiseAnnotationEvent: ${qb} raising ${ra} event (annotation id: ${Qa})`);this.raiseEvent(ra,
ta.xoe,this);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&this.BYd.eFi(ta.annotationType,`${Qa}`,Wa)}Wii(ra,Qa){Qa=c(this.sQe(Qa));ra=`${new ob(ra,Qa)}`;return!this.lMa.has(ra)}eBg(ra,Qa){var qb=ra.xoe.kJ.id;const Wa=c(Qa);qb=new ob(qb,Wa);const ta=`${qb}`;this.lMa.has(ta)?d.ULS.sendTraceTag(523337864,0,50,`AugmentationLoopAnnotationValidator.addNewAnnotation: ignoring duplicate annotation (annotation id ${qb})`):(this.lMa.set(ta,ra),this.CZ.has(Wa)?
this.CZ.get(Wa).wFa.add(qb.annotationId):this.CZ.set(Wa,{wFa:new Set([qb.annotationId]),timestamp:Date.now()}),this.fGb("New",qb,"addNewAnnotation","New"),ra=this.Q3b,Qa===ra||Qa&&ra&&Qa.DocId===ra.DocId&&Qa.Xluid===ra.Xluid&&Qa.Xrevid===ra.Xrevid?this.fGb("Valid",qb,"addNewAnnotation","ValidOnArrival"):this.QNa.add(c(Qa)))}bOf(ra){this.lMa.delete(`${ra}`);for(let [Qa,qb]of this.CZ.entries())if(Qa===ra.coauthVersion&&qb.wFa.delete(ra.annotationId))break}p$i(){Array.from(this.CZ.entries()).filter(([,
ra])=>0===ra.wFa.size).forEach(([ra])=>this.CZ.delete(ra))}hOf(ra){this.QNa.delete(ra)}lci(ra){var Qa;const qb=c(ra);(new Set(null===(Qa=this.CZ.get(qb))||void 0===Qa?void 0:Qa.wFa)).forEach(Wa=>{Wa=new ob(Wa,qb);this.fGb("Invalid",Wa,"invalidateAnnotations","InvalidOnCoauthVersionChanged");this.bOf(Wa)})}LUj(ra){var Qa;ra=c(ra);if(this.QNa.has(ra)){var qb=null===(Qa=this.CZ.get(ra))||void 0===Qa?void 0:Qa.wFa;Qa=(Qa=this.CZ.get(ra))?Date.now()-Qa.timestamp:0;for(const Wa of qb)qb=new ob(Wa,ra),this.fGb("Valid",
qb,`validateAnnotations elapsed ${Qa} ms`,"ValidAfterSomeTime");this.hOf(ra)}else d.ULS.sendTraceTag(523337863,0,50,`AugmentationLoopAnnotationValidator.validateAnnotations: ${ra} has no on-hold annotations associated with it`)}y$e(){var ra=Date.now();const Qa=[],qb=[];for(const ta of this.QNa){var Wa=this.CZ.get(ta);const ib=ra-Wa.timestamp;if(ib>this.gQe)for(const Bb of Wa.wFa)Wa=new ob(Bb,ta),this.fGb("Invalid",Wa,`invalidateExpiredAnnotations elapsed ${ib} ms`,"InvalidAfterTimeout"),Qa.push(Wa)}for(const ta of Qa)this.bOf(ta);
for(const ta of this.QNa)ra=this.CZ.get(ta),0===(null===ra||void 0===ra?void 0:ra.wFa.size)&&qb.push(ta);for(const ta of qb)this.hOf(ta);this.p$i()}}Object(t.a)(xb,"AugmentationLoopAnnotationValidator",k.a,[739]);class Va extends D.a{constructor(ra){super();this.augmentationLoopManager=null;this.$=ra;this.Fb();d.ULS.sendTraceTag(520939607,0,50,"AugmentationLoopManagerFactory.constructor: called")}create(){const ra=Date.now();f.Health.instance.recordKpiUsageForAlertableKpi("AugmentationLoopManagerCreation",
"xlalint",null);d.ULS.sendTraceTag(537170371,0,50,"AugmentationLoopManagerFactory.create: called");let Qa=null;const qb=[];u.EwaSettings.ma(432)&&(Qa=tb.GetServiceTaskFactory.Ta(this.$.da,349,350,this.ib),qb.push(Qa));cc.TaskExtensions.Aa(cc.TaskExtensions.Xd(qb,this.la,3),()=>{Ob.Bri(this.$,Qa?Qa.result:null,this.ib).then(Wa=>{d.ULS.sendTraceTag(537170370,0,50,"AugmentationLoopManagerFactory.create: Augmentation Loop runtime initialized");try{if(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6580882_AugmentationLoopManagerFactory_Create_Single_AugmentationLoopAnnotationValidator"))this.qb(this.augmentationLoopManager||
(this.augmentationLoopManager=new za(this.$,Wa,new xb(this.$.ya.AugmentationLoopAnnotationExpirationTimeoutInMs))));else{const ta=new xb(this.$.ya.AugmentationLoopAnnotationExpirationTimeoutInMs);this.qb(this.augmentationLoopManager||(this.augmentationLoopManager=new za(this.$,Wa,ta)))}u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")?Ob.qoj(this.augmentationLoopManager.glc):(Ob.Frj(this.augmentationLoopManager.IPi),Ob.Qqj(this.augmentationLoopManager.TNi))}catch(ta){f.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation",
"Exception",!1,!0,Object(b.a)(new Ib.a,{extendedProperties:new Map,durationMs:Date.now()-ra})),this.qb(null),d.ULS.sendTraceTag(42796228,0,10,`AugmentationLoopManagerFactory.create: Augmentation loop initialization failed. Exception ${ta.message}`)}}).catch(()=>{f.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation","PromiseRejected",!1,!0,Object(b.a)(new Ib.a,{extendedProperties:new Map,durationMs:Date.now()-ra}));this.qb(null);d.ULS.sendTraceTag(42796229,0,10,"AugmentationLoopManagerFactory.create: Augmentation loop initialization failed")})},
this.$.la,3)}static ka(ra){u.EwaSettings.isChangeGateEnabled("OfficeVSO:6580882_AugmentationLoopManagerFactory_Create_Single_AugmentationLoopAnnotationValidator")&&d.ULS.sendTraceTag(520939606,0,50,"AugmentationLoopManagerFactory.attach: called");ra.da.Ga(327,new Va(ra))}}Object(t.a)(Va,"AugmentationLoopManagerFactory",D.a,[]);var bb=a(10);a=a(1212);Type.registerNamespace("_Ewa");(()=>{bb.a.Fa(ra=>{Va.ka(ra)})})();Object(a.a)()},813:function(t,D,a){a.d(D,"f",function(){return e});a.d(D,"e",function(){return k});
a.d(D,"b",function(){return l});a.d(D,"d",function(){return m});a.d(D,"c",function(){return v});a.d(D,"a",function(){return w});t=a(0);var c=a(11),b=a(316),d=a(15),f=a(36);const e=(x,z,B,y)=>{d.ULS.sendTraceTag(221794372,306,50,`FormulaByExample suggestion display failure reported. Failure data ${JSON.stringify({["flowId"]:x.si,["originFormulaFlowId"]:x.Vba.si,["formulaAnonymized"]:x.anonymizedFormula,["originalFormulaAnonymized"]:x.Vba.anonymizedFormula,["range"]:x.range,["failureReason"]:z})}`);
B&&B.yw(x.si,y,{reason:z})},k=(x,z,B)=>{try{const y=r(x,z,B);window.performance.mark(y)}catch(y){d.ULS.sendTraceTag(529109767,0,10,`FormulaByExampleTelemetryGenerator.markPerformancePoint: Error thrown : ${y.message}`)}},l=x=>{for(const z in n)try{window.performance.clearMarks(r(z,x,!1)),window.performance.clearMarks(r(z,x,!0))}catch(B){d.ULS.sendTraceTag(527005662,0,10,`FormulaByExampleTelemetryGenerator.clearPerformanceFlowMarks: Error thrown : ${B.message}`)}},m=(x,z)=>{try{return{["EditCommitToSignal"]:u(`FBE_EditCommitToSignal_${z}_${x}`,
r(n.EditCommit,z,!1),r(n.SignalSent,z,!1)),["WorkflowAndNetworkTime"]:x?0:u(`FBE_WorkflowAndNetworkTime_${z}_${x}`,r(n.SignalSent,z,!1),r(n.AnnotationReceived,z,!1)),["Calculation"]:u(`FBE_Calculation_${z}_${x}`,r(n.CalculationStart,z,x),r(n.CalculationEnd,z,x)),["ModelUpdate"]:u(`FBE_ModelUpdate_${z}_${x}`,r(n.CalculationEnd,z,x),r(n.ModelUpdated,z,x)),["PreviewRender"]:u(`FBE_PreviewRendered_${z}_${x}`,r(n.ModelUpdated,z,x),r(n.PreviewRendered,z,x)),["Total"]:u(`FBE_Total_${z}_${x}`,r(n.EditCommit,
z,!1),r(n.PreviewRendered,z,x))}}catch(B){d.ULS.sendTraceTag(529109766,0,10,`FormulaByExampleTelemetryGenerator.getPreviewShownDurations: Error thrown : ${B.message}`)}},v=(x,z)=>{try{return{["UserInPreviewDuration"]:u(`FBE_InputToPreviewRemovedWithCSE_${z}_${x}`,r(n.PreviewRendered,z,x),r(n.UserInputArrived,z,x)),["InputToPreviewRemovedWithCSE"]:u(`FBE_InputToPreviewRemovedWithCSE_${z}_${x}`,r(n.UserInputArrived,z,x),r(n.PreviewRemovedWithCSE,z,x))}}catch(B){d.ULS.sendTraceTag(529109765,0,10,`FormulaByExampleTelemetryGenerator.getPreviewRemovedDurations: Error thrown : ${B.message}`)}};
var n;(function(x){x.EditCommit="EDITCOMMIT";x.SignalSent="SIGNALSENT";x.AnnotationReceived="ANNOTATIONRECEIVED";x.CalculationStart="CALCULATIONSTART";x.CalculationEnd="CALCULATIONED";x.ModelUpdated="MODELUPDATED";x.PreviewRendered="PREVIEWRENDERED";x.UserInputArrived="USERINPUTARRIVED";x.PreviewRemovedWithCSE="PREVIEWREMOVEDWITHCSE"})(n||(n={}));Object(t.b)("FormulaByExampleFlowMarks",n);const w=x=>c.HelperMethods.VWc&&b.a.$nb&&f.a.b4(x),r=(x,z,B)=>`${x}_${z+(B?"_cached":"")}`,u=(x,z,B)=>{window.performance.measure(x,
z,B);const y=window.performance.getEntriesByName(x);if(y[y.length-1])return z=y[y.length-1].duration,performance.clearMeasures(x),z;d.ULS.sendTraceTag(526984791,0,15,`FormulaByExampleTelemetryGenerator.measureTime: could not find performance entry for measure: ${x}, startMark: ${z}, endMark: ${B}`);return-1}},848:function(t,D,a){t=a(0);var c=a(15),b=a(1),d=a(186),f;(function(y){y[y.UserEditedInTable=0]="UserEditedInTable";y[y.FormulaByExampleNoTrigger=1]="FormulaByExampleNoTrigger";y[y.FlowInterrupted=
2]="FlowInterrupted";y[y.FormulaByExampleFullTrigger=3]="FormulaByExampleFullTrigger";y[y.HadCachedSuggestion=4]="HadCachedSuggestion";y[y.NoCachedSuggestion=5]="NoCachedSuggestion";y[y.PreCalcPreviewRejected=6]="PreCalcPreviewRejected";y[y.WaitingForCalcResult=7]="WaitingForCalcResult";y[y.PostCalcPreviewRejected=8]="PostCalcPreviewRejected";y[y.SuggestionDidntMatch=9]="SuggestionDidntMatch";y[y.SuggestionMatched=10]="SuggestionMatched";y[y.PreviewShouldBeShown=11]="PreviewShouldBeShown";y[y.SignalSent=
12]="SignalSent";y[y.NoSignalSent=13]="NoSignalSent";y[y.AnnotationReceived=14]="AnnotationReceived";y[y.NoFormulaFound=15]="NoFormulaFound";y[y.FormulaFound=16]="FormulaFound";y[y.WorkbookClosed=17]="WorkbookClosed";y[y.UnexpectedTransition=18]="UnexpectedTransition"})(f||(f={}));Object(t.b)("FormulaByExampleFlowState",f);const e=new Map([[f.UserEditedInTable,[f.FormulaByExampleNoTrigger,f.FormulaByExampleFullTrigger]],[f.FormulaByExampleFullTrigger,[f.FlowInterrupted,f.NoCachedSuggestion,f.HadCachedSuggestion]],
[f.NoCachedSuggestion,[f.NoSignalSent,f.SignalSent]],[f.HadCachedSuggestion,[f.PreCalcPreviewRejected,f.WaitingForCalcResult]],[f.PreCalcPreviewRejected,[f.NoSignalSent,f.SignalSent]],[f.WaitingForCalcResult,[f.NoSignalSent,f.SignalSent]]]),k=new Set([f.FormulaByExampleNoTrigger,f.FlowInterrupted,f.NoSignalSent,f.SignalSent]),l=new Map([[f.WaitingForCalcResult,[f.PostCalcPreviewRejected,f.SuggestionDidntMatch,f.SuggestionMatched]],[f.SuggestionDidntMatch,[f.PostCalcPreviewRejected,f.PreviewShouldBeShown]],
[f.SuggestionMatched,[f.PostCalcPreviewRejected,f.PreviewShouldBeShown]]]),m=new Set([f.PostCalcPreviewRejected,f.PreviewShouldBeShown]),v=new Map([[f.SignalSent,[f.AnnotationReceived]],[f.AnnotationReceived,[f.NoFormulaFound,f.FormulaFound]]]),n=new Set([f.NoFormulaFound,f.FormulaFound]),w=new Map([[f.NoCachedSuggestion,{name:"CachedSuggestion",value:!1}],[f.HadCachedSuggestion,{name:"CachedSuggestion",value:!0}],[f.PreCalcPreviewRejected,{name:"PreviewShown",value:!1,Esb:"Before applying to Calc"}],
[f.PostCalcPreviewRejected,{name:"PreviewShown",value:!1,Esb:"After returning from Calc"}],[f.SuggestionDidntMatch,{name:"SetCellMatchedSuggestion",value:!1}],[f.SuggestionMatched,{name:"SetCellMatchedSuggestion",value:!0}],[f.PreviewShouldBeShown,{name:"PreviewShown",value:!0}],[f.NoFormulaFound,{name:"FormulaFound",value:!1}],[f.FormulaFound,{name:"FormulaFound",value:!0}],[f.UnexpectedTransition,{name:"UnexpectedTransition",value:!0}]]);class r{constructor(y,A,K){this.currentState=y;this.rEj=A;
this.Xyh=K}Dta(y){const A=this.rEj.get(this.currentState);return A&&A.includes(y)?(this.currentState=y,!0):!1}get isActive(){return!this.Xyh.has(this.currentState)}Xed(){return f[this.currentState]}}Object(t.a)(r,"FormulaByExampleStateMachine",null,[]);class u{constructor(y,A,K){this.NJc=!1;this.kJi=K;this.mnc=new r(0,e,k);this.Xta={si:y,cZg:A,gkc:null,CSe:!1,TMd:!1,A3f:!1,DSe:{}}}get yji(){return this.NJc}set si(y){this.Xta.si=y}Dta(y,A){17===y?this.aM():(this.q6b(y,A),this.THg())}aM(){this.kJi(this.Xta)}q6b(y,
A){var K,G;this.mnc.Dta(y)?this.tOi(y):(null===(K=this.H_b)||void 0===K?0:K.Dta(y))?this.QFi(y):(null===(G=this.twc)||void 0===G?0:G.Dta(y))?this.iRi(y,A):this.yMi(y,A);this.ske(y,A)}tOi(y){switch(y){case 2:this.Xta.CSe=!0;break;case 7:this.H_b=new r(y,l,m);break;case 12:this.NJc=!0,this.Xta.A3f=!0,this.twc=new r(y,v,n)}}QFi(y){switch(y){case 9:this.Xta.TMd=!1;break;case 10:this.Xta.TMd=!0}}iRi(y,A){switch(y){case 14:this.NJc=!1;break;case 16:this.Xta.gkc=A?A.gkc:null}}yMi(y,A){this.ske(18,{reason:`${`Tried to change state from ${this.anj()} to ${f[y]}`}.${this.a0e(A)}`});
this.aM()}THg(){var y,A;this.mnc.isActive||(null===(y=this.H_b)||void 0===y?0:y.isActive)||(null===(A=this.twc)||void 0===A?0:A.isActive)||this.aM()}ske(y,A){if(w.has(y)){y=structuredClone(w.get(y));if(A=this.a0e(A))y.Esb||(y.Esb=""),y.Esb+=A;A=y.name;y=Object(d.b)(y,["name"]);this.Xta.DSe[A]=y}}a0e(y){return null!=y&&null!=y.reason?" "+y.reason:""}anj(){var y,A;const K=`OriginStateMachine: ${this.mnc.isActive?this.mnc.Xed():"NotActive"}`,G=`CalcStateMachine: ${(null===(y=this.H_b)||void 0===y?0:
y.isActive)?this.H_b.Xed():"NotActive"}`;y=`SignalStateMachine: ${(null===(A=this.twc)||void 0===A?0:A.isActive)?this.twc.Xed():"NotActive"}`;return`[${K}, ${G}, ${y}]`}}Object(t.a)(u,"FormulaByExampleFlowDataAggregator",null,[]);a.d(D,"b",function(){return-1});a.d(D,"a",function(){return x});class x{static getInstance(y){this.instance||(b.EwaSettings.isChangeGateEnabled("OfficeVSO:6649480_FormulaByExampleFlowAggregator")?this.instance=z.getInstance(y):this.instance=B.getInstance(y));return this.instance}}
Object(t.a)(x,"FormulaByExampleFlowsTrackerFactory",null,[]);class z{constructor(y){this.nextId=1;this.r$e=this.IMb=0;this.lia=new Map;this.ITd=new Map;this.BXf=new Map;this.Wnf=new Map;this.kwe=new Map;this.Qif=new Map;this.Dc=()=>{const A=this.JSh();if(0!==A.size){this.$.sendBeaconTraceTag(526984790,50,!1,`some pending FBE flows were not resolved by workbook closure. Total flows amount in sessions: ${this.IMb}, Unresolved flows amount: ${A.size}, pending flows: ${[...A].join()}, interrupted flows amount ${this.r$e}`);
for(const K of A)this.yw(K,17)}};this.SFj=A=>{var K=A.cZg;const G=A.si,T=A.gkc,W=A.CSe,P=A.TMd,E=A.A3f;A=A.DSe;const H=this.Qif.get(K);if(!H&&T||H&&H!==T)this.pjd(this.kwe,K),this.Qif.set(K,T);P&&this.pjd(this.Wnf,K);W&&this.r$e++;E&&this.IMb++;K={["flowId"]:G,["columnKey"]:K,["flowDataAggergation"]:A,["setCellsInColumn"]:this.BXf.get(K)||0,["suggestionChangesInColumn"]:this.kwe.get(K)||0,["matchedSuggestionsInColumn"]:this.Wnf.get(K)||0};c.ULS.sendTraceTag(512365781,0,50,`FormulaByExampleFlowsTracker.summarizeFlowOverallData: Flow Aggregation results: ${JSON.stringify(K)}`);
this.lia.delete(G)};this.$=y;this.$.ik(this.Dc)}static getInstance(y){z.instance||(z.instance=new z(y));return z.instance}KZe(){const y=this.nextId++,A=this.lia.get(-1);A?(A.si=y,this.lia.set(y,A),this.lia.delete(-1)):c.ULS.sendTraceTag(512503829,0,15,`FormulaByExampleFlowsTracker.getNewFlowId: on flowId ${y} called getNewFlowId without having matched anonymousFlow`);return y}yBf(y,A){this.yw(-1,2);this.lia.delete(-1);y=this.IJh(y,A);this.pjd(this.BXf,y);this.lia.set(-1,new u(-1,y,this.SFj))}yw(y,
A,K){if(this.lia.has(y)){var G=this.lia.get(y);G?G.Dta(A,K):c.ULS.sendTraceTag(512503828,0,10,`FormulaByExampleFlowsTracker.enterFlowToNewState: on flowId ${y} flowIdsToAggregatorsMap.has returned true but flowIdsToAggregatorsMap.get didn't find the wanted aggregator object`)}}IJh(y,A){let K=this.ITd.get(y);void 0===K&&(K=this.ITd.size,this.ITd.set(y,K));return K+"_"+A}JSh(){const y=new Set;for(const [A,K]of this.lia)K.yji&&y.add(A);return y}pjd(y,A){y.has(A)||y.set(A,0);y.set(A,y.get(A)+1)}}Object(t.a)(z,
"FormulaByExampleFlowsTracker",null,[711]);class B{constructor(y){this.nextId=1;this.y8b=new Set;this.IMb=0;this.Dc=()=>{let A=this.y8b.size;0!==A&&this.$.sendBeaconTraceTag(526984790,50,!1,"some pending FBE flows were not resolved by workbook closure. Total flows amount in sessions: {0}, Unresolved flows amount: {1}, pending flows: {2}",this.IMb,A,[...this.y8b].join())};this.$=y;this.$.ik(this.Dc)}static getInstance(y){B.instance||(B.instance=new B(y));return B.instance}yBf(){}yw(y,A){switch(A){case 12:this.upj(y);
break;case 14:this.vpj(y)}}KZe(){return this.nextId++}upj(y){this.y8b.add(y);this.IMb++}vpj(y){this.y8b.delete(y)}}Object(t.a)(B,"FormulaByExampleFlowsTrackerDeprecated",null,[711])},929:function(t,D,a){function c(fa){return k.Range.Tc(fa.row+1,fa.col+1)}t=a(0);var b=a(7),d=a(15),f=a(813),e=a(5),k=a(24),l=a(36),m=a(162),v=a(8);class n{constructor(fa,S=null,ka){this.status=fa;this.RYc=S;this.Qoc=ka}}Object(t.a)(n,"FormulaByExampleFormulaEvalResult",null,[]);var w=a(22),r=a(21),u=a(1),x=a(848);class z{constructor(fa,
S,ka,V){this.IB=!1;this.$=fa;this.calcManager=S;this.IB=V;this.ug=ka;this.Mp=x.a.getInstance(this.$);this.gridView=r.g(this.$)}Qpj(fa,S=null,ka=!1,V){const wa=fa.range.Fe(this.gridView.lh);return wa?this.OKe(fa,wa,S).then(ma=>{this.IB&&!ka&&fa.si&&Object(f.e)("CALCULATIONED",fa.si,V);if(2===ma.status)return ma;d.ULS.sendTraceTag(537161881,0,50,"FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: evalFormulaRangeOnClone CSE: Result received from calc.");return this.bRj(ma,ka,fa.si,V)}).catch(ma=>
{Object(f.f)(fa,`failed to setFormulaPreviewOnRangeModel, error in calc API: ${ma.toString()}`,this.Mp,8);return Promise.reject(`FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: Unable to EvalFormulaRange, e: ${ma.toString()}`)}):(Object(f.f)(fa,"Annotation range does not intersect loaded range",this.Mp,6),Promise.reject("FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: Annotation range does not intersect loaded range."))}OKe(fa,S,ka=null){ka=z.fCh(ka);this.Mp.yw(fa.si,7);return this.calcManager.msb(ka,
S,fa.originCell,fa.formula).then(V=>{if(!this.bhi(V))return Object(f.f)(fa,"Result object from EvalOnClone API is empty or null.",this.Mp,8),new n(2);if(!this.dIg(V,fa))return d.ULS.sendTraceTag(527005663,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone: Formula results from Calc.ts had errors."),new n(2);const wa=this.NUj(V.results,fa);if(!wa.success)return Object(f.f)(fa,`Evaluated results from calc do not match the user data in the grid or had errors from calc. reason: ${wa.reason}`,
this.Mp,8),d.ULS.sendTraceTag(537161880,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone:Formula results from Calc.ts do not match grid data."),new n(2);this.Mp.yw(fa.si,11);d.ULS.sendTraceTag(537161879,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone: EvalFormulaRange CSE: Result received from calc.");return new n(0,V.results,wa.Qoc)}).catch(V=>{Object(f.f)(fa,`failed to EvalFormulaRangeOnClone, error in calc API: ${V.toString()}`,this.Mp,8);return Promise.reject(`FormulaByExampleModelUpdater:EvalFormulaOnRange: Unable to EvalFormulaRange, e: ${V.toString()}`)})}QJg(fa,
S){if(fa)for(const ka of fa)if(this.zTe(ka)&&(fa=c(ka.value[0]),fa=this.gridView.Xb(fa))){fa=fa.cell;if(excelOnlineCalc.util.isSuccess(ka)){const V=B(ka);fa.text=V.value}fa.formulaBarText=S}}static fCh(fa){const S=ka=>({row:ka.cell.eK,column:ka.cell.dK,Ek:ka.cell.Ek,text:ka.cell.text});return fa?fa.map(S):null}dIg(fa,S){if(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6669310_FBEShowsSuggestionsWithCalcFailures"))return!0;for(const ka of fa.results){const {isSuccess:V,DKe:wa,reason:ma}=this.zTe(ka);
if(!V)return Object(f.f)(S,`Calc failed to evaluate formula. reason json: ${ma} did result in error for formula output (#VALUE, #REF etc..): ${wa}`,this.Mp,8),!1}return!0}bhi(fa){return(fa=fa.results)&&fa.length?!0:!1}zTe(fa){var S=excelOnlineCalc.util.isSuccess(fa);return S&&8===B(fa).kind?(S=c(fa.value[0]),(S=this.gridView.Xb(S))&&S.cell.text&&d.ULS.shipAssertTag(537161878,0,!1,"FormulaByExampleModelUpdater:FormulaCalculationSucceeded: formula evaluation failed, bad formula provided"),{isSuccess:!1,
DKe:!0,reason:JSON.stringify(fa.value)}):{isSuccess:S,DKe:!1,reason:JSON.stringify(fa.reason)}}bRj(fa,S,ka,V){var wa=fa.RYc;for(const ab of wa)if(excelOnlineCalc.util.isSuccess(ab)){var ma=ab.value[0];wa=B(ab);ma&&wa?(ma=c(ma),(ma=this.gridView.Xb(ma))?(ma.cell.oDd=wa.value,fa.status|=1):fa.status|=2):fa.status|=2}else fa.status|=2;this.IB&&!S&&ka&&Object(f.e)("MODELUPDATED",ka,V);return fa}NUj(fa,S){let ka=null,V=!1,wa=!1,ma=!1,ab=!1,ba=!1,Ca=!1,Na=!1;for(const sa of fa){if(!excelOnlineCalc.util.isSuccess(sa)){if(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6669310_FBEShowsSuggestionsWithCalcFailures"))if(fa=
sa.reason,"Unavailable"===fa.kind){ma=!0;fa=k.Range.Tc(fa.cell.row+1,fa.cell.col+1);this.gridView.kK(fa)&&(ab=!0,this.gridView.ye.Cfc(fa)?ba=!0:Ca=!0);continue}else ka=null!==ka&&void 0!==ka?ka:JSON.stringify({kind:fa.kind,innerKind:fa.innerKind});ka=null!==ka&&void 0!==ka?ka:"failure in calc"}var za=B(sa);if(8===za.kind)Na=!0;else{fa=c(sa.value[0]);var la=this.gridView.Xb(fa);la||(ka=null!==ka&&void 0!==ka?ka:"formatted grid cell is null");var aa=la.text;if(aa&&(za=za.value,u.EwaSettings.isChangeGateEnabled("OfficeVSO:6327953_FormatOutputResultsOfFBEDeprecated")||
(la=this.ug.kTe(za,la.cell.Ek,la.cell.oJ,la.cell.uAa,la.cell.oha),la.success&&(za=la.Px)),(aa=w.a.equals(aa,za.toString(),!1))||(ka=null!==ka&&void 0!==ka?ka:"data strings do not match"),fa.equals(S.originCell)&&(V=!0,wa=aa),V&&ka))break}}wa?this.Mp.yw(S.si,10):this.Mp.yw(S.si,9);return ka?{success:!1,reason:ka}:{success:!0,Qoc:{["hasUnavailableCells"]:ma,["hasUnexpectedUnavailableCellsInViewport"]:Ca,["hasHiddenRows"]:ba,["hasUnavailableCellsInViewport"]:ab,["hasErrorCells"]:Na}}}}Object(t.a)(z,
"FormulaByExampleModelUpdater",null,[]);const B=fa=>{if(fa=fa.value[1])return{kind:fa.kind,value:"_valueXL"in fa?fa._valueXL.toString():"type"in fa?v.a.g7c[fa.type-1]:fa.value}};var y;(function(fa){fa.accept="ACCEPT";fa.decline="DECLINE";fa.ignore="IGNORE"})(y||(y={}));Object(t.b)("PreviewOutcome",y);var A;(A||(A={})).unseen="UNSEEN";Object(t.b)("EntryState",A);const K=Object.assign(Object.assign({},A),y);class G{constructor(fa){this.state=K.unseen;this.$Ib=0;this.suggestion=fa}L7h(){this.$Ib+=1}}
Object(t.a)(G,"SuggestionEntryInternal",null,[]);class T extends Map{H$b(fa){return(fa=this.getKey(fa))?this.has(fa)?this.get(fa):null:null}C_b(fa){const S=this.getKey(fa);if(!S)return null;this.set(S,new G(fa));return this.get(S)}cTj(fa){const S=this.H$b(fa);S&&(S.suggestion=fa);return S}}Object(t.a)(T,"SuggestionsCache",Map,[]);class W{constructor(fa,S){this.formula=fa;this.$Ib=this.state=0;this.VE=S}}Object(t.a)(W,"FormulaByExampleSuggestionsCacheEntry",null,[]);class P extends T{constructor(fa,
S){super();this.calcManager=fa;this.QJ=S}C_b(fa){var S=!1;const ka=super.H$b(fa);if(!ka||(S=ka.suggestion.formula!==fa.formula))return S&&d.ULS.sendTraceTag(523842004,306,50,`FormulaByExampleSuggestionsCache.cacheSuggestion: formula changed from last cache entry, overriding cache entry. Last example count: ${ka.suggestion.VE}, current: ${fa.VE}`),d.ULS.sendTraceTag(537161877,306,50,`FormulaByExampleSuggestionsCache.cacheSuggestion: saving suggestion for table range. tableRange: ${fa.table.usedRange}, columnNumber: ${fa.column}, examplesCount ${fa.VE}, hasPreviousSuggestion: ${this.has(this.getKey(fa))}`),
(S=super.C_b(fa))||d.ULS.sendTraceTag(528889932,306,15,"SuggestionsCache.cacheSuggestion: failed to cache table suggestion due to getTableColumnKey failure."),this.QJ.lda(fa.originCell,3),S;ka.suggestion.VE!==fa.VE&&(d.ULS.sendTraceTag(523842003,306,50,`FormulaByExampleSuggestionsCache.cacheSuggestion: formula didn't change from the last cache entry, but number of examples changed. Last example ${ka.suggestion.VE}, current: ${fa.VE}`),this.QJ.lda(fa.originCell,4),fa.Vba.VE=ka.suggestion.Vba.VE);return this.cTj(fa)}H$b(fa){const S=
super.H$b(fa);return w.a.equals(null===S||void 0===S?void 0:S.suggestion.formula,fa.formula,!0)?S:null}G1e(fa,S){fa=this.i2e(fa,S);return fa?this.get(fa):(d.ULS.sendTraceTag(528889931,306,15,"FormulaByExampleSuggestionsCache.getTableCachedSuggestion: failed to get cached table suggestion due to getTableColumnKey failure."),null)}getKey(fa){return this.i2e(fa.table,fa.column)}i2e(fa,S){const ka=this.calcManager.I3a(fa);if(!ka)return null;const V=fa.usedRange,wa=S-V.left;(0>wa||wa>=ka.count)&&d.ULS.sendTraceTag(537161876,
306,10,"FormulaByExampleSuggestionCache.getUniqueTableColumnIdentifier: invalid inputs: tableRange: {0}, columnNumber: {1}.",V,S);return(S=ka.na(wa))?fa.name+"_"+S:null}}Object(t.a)(P,"FormulaByExampleSuggestionsCache",T,[]);class E{constructor(fa){this.calcManager=fa;this.cache=new Map}G1e(fa,S){fa=this.HXh(fa,S);return fa?this.cache.get(fa):(d.ULS.sendTraceTag(523842E3,306,15,"FormulaByExampleSuggestionsCache.getTableCachedSuggestion: failed to get cached table suggestion due to getTableColumnKey failure."),
null)}HXh(fa,S){return(S=this.IXh(fa,S))?fa.name+"_"+S:null}IXh(fa,S){const ka=this.calcManager.I3a(fa);if(!ka)return null;fa=fa.usedRange;const V=S-fa.left;(0>V||V>=ka.count)&&d.ULS.sendTraceTag(537161876,306,10,`FormulaByExampleSuggestionsCache.GetTableColumnName: invalid inputs: tableRange: ${fa}, columnNumber: ${S}.`);return ka.na(V)}}Object(t.a)(E,"FormulaByExampleSuggestionsCacheDeprecated",null,[]);var H=a(261);y=a(720);var F=a(694);class N extends y.a{constructor(){super();this.rows=null;
this.column=0;this.generatedFormula=this.formulas=null;this.resultKind=this.invocationMethod=this.stateID=0;this.errorMessage=this.guid=null;this.H_=Object.assign(new F.a,{T_:N.getTypeName(),B_:N.Od()})}static getTypeName(){return"AugLoop_FormulaByExample_FormulaByExampleAnnotation"}static Od(){return["AugLoop_Core_Annotation"]}}Object(t.a)(N,"FormulaByExampleAnnotation",y.a,[]);var J=a(238);class R extends N{constructor(fa,S,ka){super();Object.assign(this,S);this.$=fa;ka&&(this.mTb=ka.range,this.kRc=
ka.Wcf);this.Vba={si:this.si,VE:this.VE,originCell:this.originCell,anonymizedFormula:this.anonymizedFormula}}static z3e(fa){return parseInt(fa,10)}set si(fa){this.YGc=fa}get si(){void 0===this.YGc&&(this.YGc=R.z3e(this.guid));return this.YGc}get formula(){var fa;void 0===this.XUa&&(this.XUa=null===(fa=this.generatedFormula)||void 0===fa?void 0:fa.formula)&&"="!==this.XUa.charAt(0)&&(d.ULS.sendTraceTag(524833933,306,50,"FormulaByExampleSuggestion.formula: appending = sign as formula prefix."),this.XUa=
`=${this.XUa}`);return this.XUa}set VE(fa){this.nGc=fa}get anonymizedFormula(){var fa;void 0===this.z5d&&(this.z5d=null===(fa=this.generatedFormula)||void 0===fa?void 0:fa.anonymizedFormula);return this.z5d}get VE(){void 0===this.nGc&&(this.nGc=this.rows.length);return this.nGc}set originCell(fa){this.mTb=fa}get originCell(){void 0===this.mTb&&(d.ULS.sendTraceTag(524833932,306,10,`FormulaByExampleSuggestion.originCell: origin cell is not defined - falling back to first cell of annotation range. flowId: ${this.si}`),
this.mTb=k.Range.Tc(this.rows[0],this.column));return this.mTb}get iZd(){void 0===this.kRc&&(this.kRc=null!==this.table);return this.kRc}get table(){void 0===this.Rkb&&(this.Rkb=Object(r.g)(this.$).Db.Xj(this.originCell,!1));return this.Rkb}get range(){if(void 0===this.cx){const fa=Object(m.a)(this.table);this.cx=new k.Range(fa.top,this.column,fa.bottom,this.column,!0,!0)}return this.cx}}Object(t.a)(R,"FormulaByExampleSuggestion",N,[]);var M=a(120),L=a(969),U=a(970),X;(function(fa){fa[fa.Unknown=
0]="Unknown";fa[fa.Permanent=1]="Permanent";fa[fa.TokenExpired=2]="TokenExpired";fa[fa.ModelWorkflowNotSupported=3]="ModelWorkflowNotSupported";fa[fa.WorkbookClosed=4]="WorkbookClosed"})(X||(X={}));Object(t.b)("AugmentationLoopCloseReason",X);a.d(D,"a",function(){return da});class da{constructor(fa,S,ka,V,wa){this.NH=this.QJ=this.Cxc=this.Fjc=null;this.ULa=this.IB=!1;this.kDd=null;this.JQd=!1;this.c2a=null;this.p1f=!1;this.MGi=ma=>{d.ULS.sendTraceTag(520987789,306,50,`FormulaByExampleManager.onCloseCallback: closeReason = ${X[ma]}`)};
this.xTe=(ma,ab)=>{d.ULS.sendTraceTag(528758222,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation received.");(ma=ab.kJ)?(ma=new R(this.$,ma,this.RXi(R.z3e(ma.guid))),d.ULS.sendTraceTag(526984792,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: received annotation's flowId: ${ma.si}.`),this.Mp.yw(ma.si,14),this.IB&&!this.ULa&&Object(f.e)("ANNOTATIONRECEIVED",ma.si),null!=ma.errorMessage?(d.ULS.sendTraceTag(527005666,306,10,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation arrived with error message: ${ma.errorMessage}, flowId: ${ma.si}`),
this.Mp.yw(ma.si,15,{reason:"Annotation arrived with error message"})):ma.formula?(this.Mp.yw(ma.si,16,{gkc:ma.formula}),ma.iZd&&this.enb?(this.NH=ma,ab=this.Cxc.C_b(ma),this.p1f&&1===ma.invocationMethod?d.ULS.sendTraceTag(523850754,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: session supports suggestions from cache only. returning early after caching suggestion."):ma.VE<L.a?d.ULS.sendTraceTag(528758220,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation does not have enough examples to prompt a suggestion."):
(d.ULS.sendTraceTag(527005665,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation with formula suggestion arrived. trying to suggest/apply it. flowID: ${ma.si}`),0===ma.invocationMethod?this.Ppj(ma):this.A1f(ab)&&this.h$f(ab,!1))):this.Fsi(ma)):(d.ULS.sendTraceTag(528758221,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation does not have any formula suggestions. flowId: ${ma.si}`),this.QJ.lda(ma.originCell,2),this.Mp.yw(ma.si,15))):d.ULS.sendTraceTag(537161922,
306,15,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation is null.")};this.Llj=()=>{d.ULS.sendTraceTag(537161889,306,50,"FormulaByExampleManager.SendByExampleFeedback: opening send feedback dialog after click on card.");const ma={};ma[e.a.sU]="FormulaByExampleCard";this.$.xd(802602464,0,8,ma)};this.eRi=ma=>{this.JQd=!0;d.ULS.sendTraceTag(537161888,306,50,`FormulaByExampleManager.OnShowFormula: user clicked ShowFormula button in the card for flow ${ma}`)};this.i2h=ma=>{d.ULS.sendTraceTag(528758219,
306,50,"FormulaByExampleManager.HandleNewBlocksDuringPreview: new block arrived during preview mode.");const ab=ma.gd.block;var ba=m.a(this.NH.table);const Ca=this.NH.range.Fe(ab.qf);ba=(new k.Range(ba.top,ba.left,ba.bottom,ba.right,!0,!0)).Fe(ab.qf);const Na=[];for(let za of this.gridView.Eua(ba,ab))Na.push(za);d.ULS.sendTraceTag(537161886,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: putting skeleton for preview cells in new block ${ma.gd.hash}.`);this.NXd(Ca,!0);this.PKe(this.NH,
Na).then(za=>{d.ULS.sendTraceTag(537161885,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: putting calculated data into model and demanding re-render for block ${ma.gd.hash}.`);this.NXd(Ca,!1);this.hR.Rnf(ma.gd.block);d.ULS.sendTraceTag(512508567,306,50,`FormulaByExampleManager.handleNewBlocksDuringPreview: new FormulaByExample suggestion block rendered during preview. results: ${JSON.stringify({["flowId"]:this.NH.si,["originalFlowId"]:this.NH.Vba.si,["formulaAnonymized"]:this.NH.anonymizedFormula,
["originalFormulaAnonymized"]:this.NH.Vba.anonymizedFormula,["annotationRange"]:this.NH.range.toString(),["previewCellsMetadata"]:za.Qoc})}`);return!0}).catch(za=>{Object(f.f)(this.NH,`Exception when rendering new block during preview. ${za}`);d.ULS.sendTraceTag(537161884,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: caught exception: ${za}.`)})};this.iOf=()=>{this.$.userOperationManager.Co(this.Szd);this.Szd=null};this.wmc=(ma,ab)=>{0==ab.Kq&&(this.ULa&&this.kDd.zva(`UserOperation: ${M.a(ab.wf.operation.operationName)}`),
this.$.userOperationManager.Co(this.wmc))};this.$Li=(ma,ab)=>{d.ULS.sendTraceTag(528023709,306,50,`FormulaByExampleManager.onImmediateUndo: undo operation queued following a formula by example suggestion application. flowId=${ma} originalFlowId=${ab}`)};this.$=fa;this.enb=l.a.b4(this.$);this.p1f=u.EwaSettings.isChangeGateEnabled("OfficeVSO:6169955_ShowCachedFormulaByExampleSuggestionsOnly");this.augmentationLoopManager=S;this.calcManager=ka;this.ug=V;this.c2a=new Map;this.gridView=r.g(this.$);this.QJ=
wa;this.Mp=x.a.getInstance(this.$);this.enb&&(this.hR=this.gridView.hR,this.nDd=!1);l.a.Kec(this.$)?this.init():d.ULS.sendTraceTag(537161923,306,10,"FormulaByExampleManager.Ctor: not expected to be constructed when FG is off.")}SSi(fa,S,ka){if(ka&&this.enb){this.nDd=!1;var V=this.gridView.Db.Xj(fa,!1),wa,ma;(wa=this.Cxc.G1e(V,fa.left))&&(ma=this.A1f(wa))||this.c2a.set(S,{range:fa,Wcf:ka});wa?(this.Mp.yw(S,4),ma?(wa.suggestion.si=S,wa.suggestion.originCell=fa,d.ULS.sendTraceTag(529109774,306,50,"FormulaByExampleManager.onTableInput: A cached formula suggestion found for current input."),
this.h$f(wa,!0)):this.Mp.yw(S,6)):this.Mp.yw(S,5)}else d.ULS.shipAssertTag(524940241,306,l.a.D5a(this.$),"FormulaByExampleManager.onUserInput: expected to be called on range only in dark experiment."),this.c2a.set(S,{range:fa,Wcf:ka})}dispose(){this.$.userOperationManager.Co(this.wmc);this.iOf()}init(){da.wEe=u.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FBEDarkExperimentRowsAboveEditedCell",1);da.nah=u.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FBEDarkExperimentColumnsBeforeEditedCell",
5);const {FormulaByExampleAutoSuggestActor:fa}=a(1308);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6496246_FormulaByExampleMigrationToNewALAPI")?this.augmentationLoopManager.register(this.augmentationLoopManager.tHh().ppj().poj(this.MGi).activateAnnotation({annotationType:N.getTypeName(),mfc:!1,uCb:this.xTe}).build()):(this.augmentationLoopManager.activateAnnotation(N.getTypeName()),this.augmentationLoopManager.$O(N.getTypeName(),this.xTe));this.IB=Object(f.a)(this.$);new fa(this.$,this.calcManager,
this.IB);this.Cxc=new P(this.calcManager,this.QJ);this.enb&&(this.Fjc=new z(this.$,this.calcManager,this.ug,this.IB));d.ULS.sendTraceTag(528758223,306,50,"FormulaByExampleManager.init: init complete.")}RXi(fa){if(!this.c2a.has(fa))return null;const S=this.c2a.get(fa);this.c2a.delete(fa);return S}Fsi(fa){d.ULS.sendTraceTag(524940240,306,50,`FormulaByExampleManager.logAndCacheExperimentResult: annotation received for a given flow. tableOrRangeBucket: ${fa.iZd?"Table":"Range"}, exampleCountForSuggestion: ${fa.VE}, flowId: ${fa.si}`);
fa.iZd&&this.Cxc.C_b(fa)}Ppj(fa){this.Fjc.OKe(fa,fa.range,null).then(S=>{this.XUc(fa,1===S.status?S.RYc:null);return null}).catch(()=>{d.ULS.sendTraceTag(537161921,306,50,"FormulaByExampleManager.setFormulaOnRangeExplicit: client estimation failed for explicit by example flow.");this.XUc(fa,null)})}h$f(fa,S){d.ULS.sendTraceTag(527713160,306,50,`FormulaByExampleManager.tryDisplayFormulaSuggestionPreview: starting flow to show a formula suggestion. isFromCache: ${S}`);const ka=fa.suggestion;this.IB&&
!this.ULa&&Object(f.e)("CALCULATIONSTART",ka.si,S);const V=this.PKe(ka,null,S),wa=V.then(()=>this.hR.Ncb(ka.range,this.i2h).then(ma=>{this.ULa=!0;this.kDd=ma;this.$.userOperationManager.Fr(this.wmc);this.IB&&J.a(()=>{Object(f.e)("PREVIEWRENDERED",ka.si,S);const ab=Object(f.d)(S,ka.si);d.ULS.sendTraceTag(529109772,306,50,`FormulaByExampleManager.TryDisplayFormulaSuggestionPreview: durations for preview shown flow: ${JSON.stringify(ab)}`)},this.$.la);this.QJ.show(ka.formula,ka.range.toString(),()=>
ma.pWb("CardUI"),()=>ma.f4b("CardUI"),this.Llj,()=>this.eRi(ka.si),void 0,ka.originCell);this.QJ.lda(ka.originCell,0);return ma.Fgj}));Promise.all([V,wa]).then(ma=>{this.nDd=!0;this.w2h(ma[0],ma[1],fa,S)}).catch(ma=>{Object(f.f)(ka,`Failed to show formula preview due to a promise (model update or preview render) rejection. rejection reason: ${ma}`);d.ULS.sendTraceTag(537161920,306,15,`FormulaByExampleManager.TryDisplayFormulaSuggestionPreview: failed to show formula preview due to promise rejection. rejection reason: ${ma}`);
this.QJ.lda(ka.originCell,5,ma);fa.state=K.ignore})}PKe(fa,S=null,ka){return this.Fjc.Qpj(fa,S,this.ULa,ka).then(V=>{d.ULS.sendTraceTag(537161887,306,50,`FormulaByExampleManager.EvaluateFormulaAndUpdateModel: model update completed. result: ${V.status}.`);switch(V.status){case 3:case 1:return 3===V.status&&Object(f.f)(fa,"Preview shown, but only partially. some cells failed to evaluate."),Promise.resolve(V);case 2:return Promise.reject("Calc estimation or model update failed");default:return Promise.reject("Calc estimation failed")}})}w2h(fa,
S,ka,V){const wa=this.JQd;this.lfj();const ma=ka.suggestion;this.IB&&Object(f.e)("USERINPUTARRIVED",ma.si,V);this.NXd(ma.range,!1);this.QJ.hide();J.a(()=>{this.IB&&Object(f.e)("PREVIEWREMOVEDWITHCSE",ma.si,V);const ab={["flowId"]:ma.si,["originalFlowId"]:ma.Vba.si,["caller"]:S.Fue,["formulaAnonymized"]:ma.anonymizedFormula,["originalFormulaAnonymized"]:ma.Vba.anonymizedFormula,["suggestionOutcome"]:S.Roc,["annotationRange"]:ma.range.toString(),["isFullyInViewport"]:this.gridView.kK(ma.range),["isCachedSuggestion"]:V,
["showFormulaClicked"]:wa,["exampleCount"]:ma.VE,["originalExampleCount"]:ma.Vba.VE,["seenCount"]:ka.$Ib,["previewCellsMetadata"]:fa.Qoc,["previewShownDurations"]:this.IB?Object(f.d)(V,ma.si):"none",["previewRemovedDurations"]:this.IB?Object(f.c)(V,ma.si):"none"};d.ULS.sendTraceTag(388780100,306,50,`FormulaByExampleManager.handlePreviewResult: FormulaByExample flow results: ${JSON.stringify(ab)}`);Object(f.b)(ma.si)},this.$.la);d.ULS.sendTraceTag(523842074,306,50,`FormulaByExampleManager.handlePreviewResult: User ${S.Roc} the formula via ${S.Fue}`);
ka.state=S.Roc;ka.L7h();"ACCEPT"===S.Roc&&this.XUc(ma,fa.RYc);this.$.userOperationManager.Co(this.wmc)}lfj(){this.ULa=!1;this.kDd=null;this.JQd=!1}XUc(fa,S){const ka=Object(b.a)(new H.a,{Text:fa.formula});this.gridView.setCell(ka,fa.originCell,1,127,null,0,fa.range,2);this.Fjc.QJg(S,fa.formula);d.ULS.sendTraceTag(537161883,306,50,`FormulaByExampleManager.applyFormulaSuggestionOnRange: applied formula on table, range: ${fa.range}`);this.Szd=(V,wa)=>{0==wa.Kq&&(170==wa.wf.operation.operationName&&this.$Li(fa.si,
fa.Vba.si),this.iOf())};this.$.userOperationManager.Fr(this.Szd)}A1f(fa){const S=fa.suggestion;return this.Lei(fa.suggestion.si)?fa.state===K.decline?(this.QJ.lda(fa.suggestion.originCell,6,U.a.Kig),d.ULS.sendTraceTag(528758217,306,50,`FormulaByExampleManager.shouldShowPreview: user declined this suggestion before, not showing again. flowId: ${S.si}`),!1):fa.state===K.ignore&&2<=fa.$Ib?(this.QJ.lda(fa.suggestion.originCell,6,U.a.Jig),d.ULS.sendTraceTag(528758216,306,50,`FormulaByExampleManager.shouldShowPreview: user saw suggestion at least twice and ignored last time. not showing again. flowId: ${S.si}`),
!1):S.VE<L.a?(this.QJ.lda(fa.suggestion.originCell,6,U.a.nig),d.ULS.sendTraceTag(528758215,306,50,`FormulaByExampleManager.shouldShowPreview: cached suggestion does not have enough examples. not showing preview. flowId: ${S.si}`),!1):!0:(this.QJ.lda(fa.suggestion.originCell,6,U.a.nhg),!1)}NXd(fa,S){for(let V=fa.top;V<=fa.bottom;V++)for(let wa=fa.left;wa<=fa.right;wa++){var ka=k.Range.Tc(V,wa);if(ka=this.gridView.Xb(ka))ka.cell.e3f=S&&!ka.cell.oDd}}Lei(fa){return this.enb?this.nDd?(d.ULS.sendTraceTag(528758218,
306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview again as preview already was shown for the current edit. flowId: ${fa}`),!1):this.ULa?(d.ULS.sendTraceTag(527005664,306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview for this suggestion as preview is already showing. flowId: ${fa}`),!1):this.gridView.$a?(d.ULS.sendTraceTag(524813027,306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview for this suggestion as user is editing. flowId: ${fa}`),!1):
!0:(d.ULS.debugAssertTag(524940239,306,!1,`FormulaByExampleManager.shouldShowPreview: Not expected to be called when no proactive suggestions are enabled. flowId: ${fa}`),!1)}}Object(t.a)(da,"FormulaByExampleManager",null,[693,3])},969:function(t,D,a){a.d(D,"a",function(){return 2})}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSEsNext.augmentationloop.js.map/f9e6820ff7c25981e67db045b4beb086/EwaDSEsNext.augmentationloop.js.map